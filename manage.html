<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TestHub - 测试管理平台</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="api-service.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            height: 2000px;
            overflow: hidden;
        }

        .content {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            overflow-y: scroll;
        }

        .tab-navigation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            gap: 0;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            align-items: center;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-right: 30px;
            padding: 10px 0;
            cursor: pointer;
            user-select: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s;
        }

        .logo-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .logo-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
        }

        .logo-subtitle {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
            letter-spacing: 1px;
        }

        .tab-btn {
            padding: 15px 30px;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            border-bottom-color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .header-left {
            flex: 1;
            min-width: 0;
        }

        .header-right {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 14px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .executor-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .executor-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .executor-btn.offline {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .executor-btn.offline:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .upload-area {
            margin-top: 10px;
        }

        .upload-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 14px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .container {
            display: flex;
            height: calc(100vh - 140px);
            margin: 20px;
            gap: 20px;
        }

        .sidebar {
            width: 350px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            font-size: 18px;
            margin: 0;
            color: white;
            text-align: center;
            padding: 15px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px 10px 0 0;
            flex-shrink: 0;
        }

        /* 侧边栏Tab样式 */
        .sidebar-tabs {
            display: flex;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px 10px 0 0;
            flex-shrink: 0;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px 0;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .sidebar-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            border-bottom-color: white;
        }

        .sidebar-content {
            padding: 0;
            overflow-y: auto;
            flex: 1;
            display: none;
        }

        .sidebar-content.active {
            display: block;
        }

        /* 优先级标签 */
        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 6px;
        }

        .priority-badge.P0 {
            background: #ef4444;
            color: white;
        }

        .priority-badge.P1 {
            background: #f59e0b;
            color: white;
        }

        .priority-badge.P2 {
            background: #3b82f6;
            color: white;
        }

        .priority-badge.P3 {
            background: #6b7280;
            color: white;
        }

        .priority-badge.P4 {
            background: #d1d5db;
            color: #4b5563;
        }

        .project-list {
            padding: 20px;
            margin: 0;
            overflow-y: auto;
            flex: 1;
            list-style: none;
        }

        .project-item {
            margin-bottom: 6px;
        }

        .project-name {
            font-weight: 600;
            color: #374151;
            padding: 8px 10px;
            background: #f5f7fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-name:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        /* 从仓库创建的菜单样式 */
        .project-name.from-repository {
            background: linear-gradient(90deg, #dbeafe 0%, #f0f9ff 50%, transparent 100%);
            border-left: 4px solid #3b82f6;
        }

        .project-name.from-repository:hover {
            background: linear-gradient(90deg, #bfdbfe 0%, #dbeafe 50%, #f0f9ff 100%);
            border-left-color: #2563eb;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .test-case-list {
            list-style: none;
            margin-left: 15px;
            margin-top: 5px;
        }

        .test-case-item {
            padding: 6px 12px;
            margin: 3px 0;
            background: #f9f9f9;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .test-case-item:hover {
            background: #e8e8e8;
        }

        .test-case-item.active {
            background: #667eea;
            color: white;
        }

        .test-case-item.dragging {
            opacity: 0.5;
            cursor: move;
        }

        .menu-item.drag-over {
            background: #e0e7ff !important;
            border: 2px dashed #667eea;
        }

        .status-badge {
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            margin-left: 3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            cursor: help;
        }

        .status-group {
            display: flex;
            gap: 4px;
            align-items: center;
            margin-left: 0;
        }

        .test-case-name {
            flex: 1;
        }

        /* 执行按钮样式 - 冒烟用例专用 */
        .execute-btn {
            padding: 5px 12px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            transition: all 0.3s;
            margin-left: 8px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
            position: relative;
            overflow: hidden;
        }

        .execute-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .execute-btn:hover::before {
            left: 100%;
        }

        .execute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
        }

        .execute-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }

        .execute-btn.executing {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            cursor: wait;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* 批量执行按钮样式 */
        .execute-btn-menu {
            padding: 4px 10px;
            font-size: 11px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);
        }

        .execute-btn-menu:hover {
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.5);
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        }

        .test-case-item-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .status-badge {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .status-badge:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .status-passed {
            background: #10b981;
            color: white;
        }

        .status-failed {
            background: #ef4444;
            color: white;
        }

        .status-skipped {
            background: #f59e0b;
            color: white;
        }

        .status-pending {
            background: #d1d5db;
            color: #6b7280;
        }

        .main-content {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
        }

        .test-case-detail {
            display: flex;
            flex-direction: row;
            gap: 30px;
            height: 100%;
        }

        .test-case-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            max-height: 100%;
        }

        .test-case-actions {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 2px solid #667eea;
            overflow-y: auto;
            max-height: 100%;
        }

        .test-case-header {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .test-case-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-content {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.8;
            color: #4b5563;
        }

        .section-content ul {
            list-style: none;
            padding-left: 0;
        }

        .section-content li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .section-content li:before {
            content: "•";
            position: absolute;
            left: 5px;
            color: #667eea;
            font-weight: bold;
        }

        .platform-tabs {
            display: flex;
            gap: 10px;
            margin-top: 0;
            padding-bottom: 0;
            border-bottom: none;
            flex-shrink: 0;
        }

        .platform-tab {
            flex: 1;
            padding: 10px 20px;
            background: #f3f4f6;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6b7280;
            text-align: center;
            transition: all 0.3s;
        }

        .platform-tab:hover {
            background: #e5e7eb;
        }

        .platform-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 0;
            padding-top: 0;
            flex-shrink: 0;
            background: white;
        }

        .action-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-pass {
            background: #10b981;
            color: white;
        }

        .btn-pass:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-fail {
            background: #ef4444;
            color: white;
        }

        .btn-fail:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-skip {
            background: #f59e0b;
            color: white;
        }

        .btn-skip:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* 新的按钮布局区域 */
        .buttons-area {
            background: #fafafa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            margin-top: 20px;
        }

        .buttons-section {
            margin-bottom: 15px;
        }

        .buttons-section:last-child {
            margin-bottom: 0;
        }

        .action-buttons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .section-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* 状态按钮组 - 横向排列 */
        .status-buttons {
            display: flex;
            gap: 10px;
        }

        .status-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .status-btn:active {
            transform: translateY(0);
        }

        .status-btn.btn-pass {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .status-btn.btn-pass:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .status-btn.btn-fail {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .status-btn.btn-fail:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .status-btn.btn-skip {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .status-btn.btn-skip:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        /* 平台按钮组 - 横向排列 */
        .platform-buttons {
            display: flex;
            gap: 10px;
        }

        .platform-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #d1d5db;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: #4b5563;
        }

        .platform-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .platform-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .platform-btn:active {
            transform: translateY(0);
        }

        .btn-export {
            background: #6366f1;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .btn-export:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }

        #fileInput {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 确保滚动平滑 */
        * {
            scroll-behavior: smooth;
        }

        .collapse-icon {
            transition: transform 0.3s;
            display: inline-block;
        }

        .collapse-icon.collapsed {
            transform: rotate(0deg);
        }

        .collapse-icon:not(.collapsed) {
            transform: rotate(90deg);
        }

        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            z-index: 10000;
            min-width: 180px;
            display: none;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #333;
        }

        .context-menu-item:hover {
            background: #f3f4f6;
        }

        .context-menu-item.danger:hover {
            background: #fee;
            color: #ef4444;
        }

        .menu-item {
            font-weight: 600;
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            user-select: none;
            font-size: 14px;
        }

        .menu-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: #e8eef7 !important;
        }

        .menu-content {
            margin-left: 8px;
            margin-bottom: 8px;
        }

        /* 编辑模式样式 */
        .edit-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 10px;
        }

        .edit-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        .edit-list {
            list-style: none;
            padding: 0;
        }

        .edit-list-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .edit-list-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #667eea;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-add {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .btn-save {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .btn-cancel {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-left: auto;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-edit:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-execute-detail {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }

        .btn-execute-detail:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
        }

        .btn-execute-detail:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }

        .btn-execute-detail.executing {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            cursor: wait;
            animation: pulse 1.5s infinite;
        }

        .btn-edit:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* 弹窗样式 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            min-width: 500px;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            margin-bottom: 8px;
        }

        .modal-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .modal-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-primary {
            background: #ef4444;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .modal-btn-secondary {
            background: #6b7280;
            color: white;
        }

        .modal-btn-secondary:hover {
            background: #4b5563;
        }

        .fail-reason-display {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .fail-reason-title {
            font-size: 14px;
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fail-reason-text {
            font-size: 14px;
            color: #7f1d1d;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* 搜索框样式 */
        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .search-menu-filter {
            padding: 10px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
        }

        .search-menu-filter:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .search-menu-filter option {
            background: #667eea;
            color: white;
        }

        .search-input {
            flex: 1;
            max-width: 400px;
            padding: 10px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .search-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .search-result-hint {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .test-case-item.search-highlight {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .test-case-item.search-highlight:hover {
            background: #fde68a;
        }

        /* 圆盘进度图样式 */
        .progress-circle-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 420px;
            max-width: 500px;
        }

        /* 菜单选择器样式 */
        .menu-selector {
            margin-bottom: 15px;
            text-align: center;
        }

        .menu-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            background: white;
            cursor: pointer;
            outline: none;
            transition: all 0.3s;
        }

        .menu-selector select:hover {
            border-color: #764ba2;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .menu-selector select:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .progress-circle-header {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .menu-progress-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .menu-progress-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .menu-progress-title {
            font-size: 14px;
            font-weight: 500;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-circles-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .progress-circle-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .platform-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-align: center;
        }

        .progress-circle-canvas {
            cursor: pointer;
            display: block;
        }

        .progress-circle-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        .progress-circle-total {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .progress-circle-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .progress-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            white-space: nowrap;
            z-index: 10001;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .progress-tooltip.show {
            display: block;
        }

        .progress-tooltip-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .progress-tooltip-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* 日志下载按钮 */
        .download-logs-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            font-size: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 999;
            font-weight: 500;
        }

        .download-logs-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        .download-logs-btn:active {
            transform: translateY(0);
        }

        /* Loading 动画 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== 进度统计模块样式 ========== */
        .stats-module {
            margin: 20px;
        }

        .stats-header-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .stats-header-section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
        }

        .menu-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .menu-selector label {
            font-weight: 500;
            color: #666;
        }

        .menu-selector select {
            flex: 1;
            max-width: 400px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .stats-loading {
            background: white;
            padding: 60px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .stats-empty-state {
            background: white;
            padding: 60px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* 整体统计卡片 */
        .overall-stats-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .overall-stats-card h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-title {
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .total-count {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .platform-stat {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .platform-stat:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .platform-name {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .platform-numbers {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-badge.pass { color: #10b981; }
        .stat-badge.fail { color: #ef4444; }
        .stat-badge.skip { color: #f59e0b; }
        .stat-badge.pending { color: #9ca3af; }

        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: #f3f4f6;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            display: flex;
            transition: all 0.3s;
        }

        .progress-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: 600;
            transition: width 0.3s;
        }

        .progress-segment.pass { background: #10b981; }
        .progress-segment.fail { background: #ef4444; }
        .progress-segment.skip { background: #f59e0b; }

        .progress-text {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }

        /* 子菜单统计表格 */
        .submenu-stats-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .submenu-stats-card h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }

        .submenu-table {
            width: 100%;
            border-collapse: collapse;
        }

        .submenu-table thead {
            background: #f9fafb;
        }

        .submenu-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 14px;
            border-bottom: 2px solid #e5e7eb;
        }

        .submenu-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #333;
        }

        .submenu-table tbody tr {
            transition: background 0.2s;
        }

        .submenu-table tbody tr:hover {
            background: #f9fafb;
        }

        .submenu-name {
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
        }

        .submenu-name:hover {
            text-decoration: underline;
        }

        .platform-progress {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .platform-progress-text {
            font-size: 13px;
            color: #666;
        }

        .mini-progress {
            width: 80px;
            height: 6px;
            background: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
        }

        .mini-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .mini-progress-fill.high { background: #10b981; }
        .mini-progress-fill.medium { background: #f59e0b; }
        .mini-progress-fill.low { background: #ef4444; }

        .pass-rate {
            font-weight: 600;
            font-size: 15px;
        }

        .pass-rate.high { color: #10b981; }
        .pass-rate.medium { color: #f59e0b; }
        .pass-rate.low { color: #ef4444; }

        .submenu-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        /* ========== TAB 3: 用例仓库样式 ========== */
        .version-create-panel {
            background: white;
            padding: 25px;
            margin: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-create {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .repository-main-container {
            display: flex;
            gap: 20px;
            margin: 0 30px 30px;
        }

        .repository-section {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .repository-testcase-section {
            flex: 1.5;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .repository-section-header {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .repository-menu-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .repository-menu-item:hover {
            background: #f3f4f6;
        }

        .repository-menu-item.selected {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
        }

        .repository-menu-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .repository-submenu-list {
            margin-left: 35px;
        }

        .repository-testcase-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .repository-testcase-actions {
            display: flex;
            gap: 10px;
        }

        .repository-testcase-list-container {
            flex: 1;
            overflow-y: auto;
        }

        .repository-testcase-list {
            max-height: 500px;
        }

        .repository-testcase-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 5px 0;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .repository-testcase-item:hover {
            border-color: #3b82f6;
            background: #f9fafb;
        }

        .repository-testcase-item.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .repository-testcase-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .repository-testcase-detail {
            border-top: 2px solid #e5e7eb;
            padding-top: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .repository-detail-header {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .repository-detail-section {
            margin-bottom: 15px;
        }

        .repository-detail-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .repository-detail-content {
            font-size: 14px;
            color: #374151;
            background: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            line-height: 1.6;
        }

        .repository-detail-content ul {
            margin-left: 20px;
        }

        .repository-detail-content li {
            margin: 5px 0;
        }

        .repository-selection-summary {
            background: white;
            padding: 15px 30px;
            margin: 0 30px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .repository-summary-stats {
            display: flex;
            gap: 30px;
        }

        .repository-stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 创建版本模态弹窗 */
        .create-version-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .create-version-modal.show {
            display: flex;
        }

        .create-version-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .create-version-modal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .create-version-modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: #374151;
            flex: 1;
        }

        .create-version-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .create-version-modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .create-version-modal-body {
            margin-bottom: 20px;
        }

        .create-version-form-group {
            margin-bottom: 20px;
        }

        .create-version-form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .create-version-form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .create-version-form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .create-version-summary {
            background: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .create-version-summary-title {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .create-version-summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            font-size: 14px;
        }

        .create-version-summary-label {
            color: #6b7280;
        }

        .create-version-summary-value {
            font-weight: 600;
            color: #667eea;
        }

        .create-version-modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .create-version-btn-cancel {
            padding: 10px 20px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-version-btn-cancel:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .create-version-btn-confirm {
            padding: 10px 20px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-version-btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .create-version-btn-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ========== 执行进度弹窗样式 ========== */
        .execution-progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .execution-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .execution-modal .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid #e8ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .execution-modal .modal-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .execution-modal .modal-title .icon.rotating {
            font-size: 24px;
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .execution-modal .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .execution-modal .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .test-case-info {
            padding: 20px 28px;
            background: #f8f9fb;
            border-bottom: 1px solid #e8ecef;
        }

        .test-case-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .test-case-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #6b7785;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-section {
            padding: 28px;
        }

        .overall-progress {
            margin-bottom: 28px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .progress-percentage {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar-container {
            height: 8px;
            background: #e8ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255,255,255,0.3) 50%,
                transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .steps-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .step-item {
            padding: 16px;
            border-left: 3px solid #e8ecef;
            margin-bottom: 12px;
            background: #f8f9fb;
            border-radius: 8px;
            transition: all 0.3s;
            position: relative;
        }

        .step-item.completed {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .step-item.running {
            border-left-color: #667eea;
            background: #eef2ff;
            animation: pulse 2s ease-in-out infinite;
        }

        .step-item.pending {
            border-left-color: #e8ecef;
            background: #f8f9fb;
            opacity: 0.6;
        }

        .step-item.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(102, 126, 234, 0); }
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .step-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .step-item.completed .step-icon {
            background: #10b981;
            color: white;
        }

        .step-item.running .step-icon {
            background: #667eea;
            color: white;
            animation: rotate 2s linear infinite;
        }

        .step-item.pending .step-icon {
            background: #e8ecef;
            color: #9ca3af;
        }

        .step-item.error .step-icon {
            background: #ef4444;
            color: white;
        }

        .step-title {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
        }

        .step-time {
            font-size: 12px;
            color: #9ca3af;
        }

        .step-description {
            font-size: 13px;
            color: #6b7785;
            margin-left: 40px;
            line-height: 1.6;
        }

        .step-detail {
            margin-top: 8px;
            margin-left: 40px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            color: #4b5563;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .execution-modal .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid #e8ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fb;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.running {
            background: #eef2ff;
            color: #667eea;
        }

        .status-badge.completed {
            background: #f0fdf4;
            color: #10b981;
        }

        .status-badge.failed {
            background: #fef2f2;
            color: #ef4444;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .execution-modal .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .execution-modal .btn-cancel {
            background: white;
            color: #6b7785;
            border: 1px solid #e8ecef;
        }

        .execution-modal .btn-cancel:hover {
            background: #f8f9fb;
        }

        .execution-modal .btn-view-result {
            background: #667eea;
            color: white;
        }

        .execution-modal .btn-view-result:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .steps-list::-webkit-scrollbar {
            width: 6px;
        }

        .steps-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .steps-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .steps-list::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
<div class="content">
    <!-- TAB 导航 -->
    <div class="tab-navigation">
        <!-- LOGO -->
        <div class="app-logo" onclick="switchTab('home')">
            <div class="logo-icon">🚀</div>
            <div class="logo-text">
                <div class="logo-title">TestHub</div>
            </div>
        </div>

        <button class="tab-btn active" onclick="switchTab('home')">
            🏠 首页
        </button>
        <button class="tab-btn" onclick="switchTab('data')">
            📊 数据管理
        </button>
        <button class="tab-btn" onclick="switchTab('repository')">
            📦 用例仓库
        </button>
    </div>

    <!-- TAB 1: 首页 -->
    <div id="tab-home" class="tab-content active">
        <div class="header">
            <div class="header-left">
                <div class="upload-area">
                    <input type="file" id="fileInput" accept=".json,.md,.txt,.xmind,.xlsx,.xls" style="display: none;"/>
                    <button class="upload-btn" onclick="createMenu()">
                        ➕ 新增版本号
                    </button>
                </div>
                <div class="search-container">
                    <select id="searchMenuFilter" class="search-menu-filter">
                        <option value="">所有菜单</option>
                    </select>
                    <input type="text" id="searchInput" class="search-input" placeholder="🔍 搜索不通过原因..." onkeyup="handleSearchKeyup(event)">
                    <button class="search-btn" onclick="performSearch()">搜索</button>
                    <button class="search-btn" onclick="clearSearch()" style="background: #6b7280;">清除</button>
                    <span id="searchResultHint" class="search-result-hint" style="display: none;"></span>
                </div>
            </div>
            <div class="header-right">
                <button id="executorControlBtn" class="executor-btn offline" onclick="toggleExecutor()">
                    <span id="executorIcon">🔴</span>
                    <span id="executorText">启动执行服务</span>
                </button>
                <div class="user-info">
                    <div class="user-avatar">👤</div>
                    <span id="username">Admin</span>
                </div>
                <button class="logout-btn" onclick="handleLogout()">退出登录</button>
            </div>
        </div>

        <div class="container">
            <div class="sidebar">
                <!-- 侧边栏Tab导航 -->
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="testcase" onclick="switchSidebarTab('testcase')">
                        📋 测试用例
                    </button>
                    <button class="sidebar-tab" data-tab="smoke" onclick="switchSidebarTab('smoke')">
                        🔥 冒烟用例
                    </button>
                </div>

                <!-- 测试用例菜单 -->
                <div id="testcaseMenuContent" class="sidebar-content active">
                    <ul class="project-list" id="projectList">
                        <!-- 项目列表将动态生成 -->
                    </ul>
                </div>

                <!-- 冒烟用例菜单 -->
                <div id="smokeMenuContent" class="sidebar-content" style="display: none;">
                    <ul class="project-list" id="smokeProjectList">
                        <!-- 冒烟用例列表将动态生成 -->
                    </ul>
                </div>
            </div>

            <div class="main-content">
                <div class="empty-state" id="emptyState">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p>请上传测试用例文件开始测试</p>
                </div>

                <div class="test-case-detail" id="testCaseDetail" style="display: none;">
                    <!-- 测试用例详情将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 菜单右键菜单 -->
        <div id="contextMenu" class="context-menu">
            <div class="context-menu-item" onclick="uploadTestCasesToMenu()">
                📁 上传测试用例
            </div>
            <div class="context-menu-item" onclick="renameMenu()">
                ✏️ 修改名称
            </div>
            <div class="context-menu-item danger" onclick="deleteMenu()">
                🗑️ 删除菜单
            </div>
        </div>

        <!-- 项目右键菜单 -->
        <div id="projectContextMenu" class="context-menu">
            <div class="context-menu-item danger" onclick="deleteProject()">
                🗑️ 删除项目
            </div>
        </div>

        <!-- 测试用例右键菜单 -->
        <div id="testCaseContextMenu" class="context-menu">
            <div class="context-menu-item" onclick="copyTestCase()">
                📋 复制
            </div>
            <div class="context-menu-item" onclick="pasteTestCase()" id="pasteMenuItem">
                📄 粘贴
            </div>
            <div class="context-menu-item danger" onclick="deleteTestCaseFromContextMenu()">
                🗑️ 删除
            </div>
        </div>

        <!-- 不通过原因弹窗 -->
        <div id="failReasonModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    ❌ 填写不通过原因
                </div>
                <div class="modal-body">
                    <label class="modal-label">请详细说明测试不通过的原因：</label>
                    <textarea id="failReasonInput" class="modal-textarea" placeholder="请输入不通过的具体原因..."></textarea>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" onclick="closeFailReasonModal()">取消</button>
                    <button class="modal-btn modal-btn-primary" onclick="confirmFailReason()">确认</button>
                </div>
            </div>
        </div>

        <!-- 工具提示 -->
        <div id="progressTooltip" class="progress-tooltip"></div>

        <!-- Loading 遮罩层 -->
        <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px 50px; border-radius: 10px; text-align: center; min-width: 300px;">
                <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <div id="loadingText" style="color: #333; font-size: 16px; font-weight: 500; margin-bottom: 20px; white-space: pre-line;">正在加载...</div>
                <div id="loadingCancelBtn" style="display: none;">
                    <button onclick="cancelCurrentExecution()" style="background: #ef4444; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s;">
                        取消执行
                    </button>
                </div>
            </div>
        </div>

        <!-- 加载错误提示 -->
        <div id="loadErrorOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                <button onclick="retryLoadData()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                    🔄 重新加载
                </button>
            </div>
        </div>

        <!-- 日志下载按钮 -->
        <button id="downloadLogsBtn" class="download-logs-btn" onclick="downloadLogs()" title="下载操作日志">
            📋 下载日志
        </button>
    </div>

    <!-- TAB 2: 数据管理 -->
    <div id="tab-data" class="tab-content">
        <div class="header">
            <div class="header-left">
                <h1>📊 数据管理</h1>
                <div class="upload-area">
                    <button class="btn-export" onclick="exportResults()">
                        💾 导出测试结果
                    </button>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">👤</div>
                    <span id="username2">Admin</span>
                </div>
                <button class="logout-btn" onclick="handleLogout()">退出登录</button>
            </div>
        </div>

        <!-- 进度统计模块 -->
        <div class="stats-module">
            <!-- 统计头部 -->
            <div class="stats-header-section">
                <h2>📈 按菜单统计</h2>
                <div class="menu-selector">
                    <label>选择版本/菜单：</label>
                    <select id="statsMenuSelect" onchange="loadStatsData()">
                        <option value="">请选择...</option>
                    </select>
                    <button class="refresh-btn" onclick="refreshStats()">🔄 刷新统计</button>
                </div>
            </div>

            <!-- 加载状态 -->
            <div id="statsLoading" class="stats-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>正在加载统计数据...</p>
            </div>

            <!-- 空状态 -->
            <div id="statsEmpty" class="stats-empty-state">
                <div class="empty-state-icon">📊</div>
                <p>请选择一个版本/菜单查看进度统计</p>
            </div>

            <!-- 统计内容 -->
            <div id="statsContent" style="display: none;">
                <!-- 整体统计 -->
                <div class="overall-stats-card">
                    <h3>📦 当前菜单整体进度</h3>
                    <div class="menu-title" id="statsCurrentMenuName">-</div>
                    <div class="total-count">总用例数: <strong id="statsTotalCount">0</strong></div>

                    <!-- Android 统计 -->
                    <div class="platform-stat">
                        <div class="platform-header">
                            <div class="platform-name">📱 Android</div>
                            <div class="platform-numbers">
                                <span class="stat-badge pass">✓ <span id="statsAndroidPass">0</span></span>
                                <span class="stat-badge fail">✗ <span id="statsAndroidFail">0</span></span>
                                <span class="stat-badge skip">〇 <span id="statsAndroidSkip">0</span></span>
                                <span class="stat-badge pending">⏸️ <span id="statsAndroidPending">0</span></span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="statsAndroidProgressBar"></div>
                            <div class="progress-text" id="statsAndroidRate">执行率: 0%</div>
                        </div>
                    </div>

                    <!-- iOS 统计 -->
                    <div class="platform-stat">
                        <div class="platform-header">
                            <div class="platform-name">🍎 iOS</div>
                            <div class="platform-numbers">
                                <span class="stat-badge pass">✓ <span id="statsIosPass">0</span></span>
                                <span class="stat-badge fail">✗ <span id="statsIosFail">0</span></span>
                                <span class="stat-badge skip">〇 <span id="statsIosSkip">0</span></span>
                                <span class="stat-badge pending">⏸️ <span id="statsIosPending">0</span></span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="statsIosProgressBar"></div>
                            <div class="progress-text" id="statsIosRate">执行率: 0%</div>
                        </div>
                    </div>

                    <!-- H5 统计 -->
                    <div class="platform-stat">
                        <div class="platform-header">
                            <div class="platform-name">🌐 H5</div>
                            <div class="platform-numbers">
                                <span class="stat-badge pass">✓ <span id="statsH5Pass">0</span></span>
                                <span class="stat-badge fail">✗ <span id="statsH5Fail">0</span></span>
                                <span class="stat-badge skip">〇 <span id="statsH5Skip">0</span></span>
                                <span class="stat-badge pending">⏸️ <span id="statsH5Pending">0</span></span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="statsH5ProgressBar"></div>
                            <div class="progress-text" id="statsH5Rate">执行率: 0%</div>
                        </div>
                    </div>
                </div>

                <!-- 子菜单进度明细 -->
                <div class="submenu-stats-card">
                    <h3>📊 子菜单进度明细</h3>
                    <div id="submenuStatsTableContainer">
                        <table class="submenu-table">
                            <thead>
                                <tr>
                                    <th>子菜单名称</th>
                                    <th style="text-align: center;">总数</th>
                                    <th style="text-align: center;">Android</th>
                                    <th style="text-align: center;">iOS</th>
                                    <th style="text-align: center;">H5</th>
                                    <th style="text-align: center;">执行率</th>
                                </tr>
                            </thead>
                            <tbody id="submenuStatsTableBody">
                                <!-- 子菜单数据将动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div id="submenuStatsEmpty" class="submenu-empty" style="display: none;">
                        <p>该菜单下暂无子菜单</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 3: 用例仓库 -->
    <div id="tab-repository" class="tab-content">
        <!-- 创建版本面板 -->
        <div class="version-create-panel">
            <div>
                <h2 style="color: #667eea; margin: 0; display: flex; align-items: center; gap: 10px;">🎯 创建新版本</h2>
                <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px 16px; margin-top: 10px; border-radius: 4px;">
                    <p style="margin: 0; color: #1e40af; font-size: 14px;">💡 从全量用例中选择需要的模块，点击"创建版本"按钮即可创建新版本测试。</p>
                </div>
            </div>
            <button class="btn btn-create" onclick="createVersionFromRepository()">✅ 创建版本</button>
        </div>

        <!-- 主要内容区域 -->
        <div class="repository-main-container">
            <!-- 左侧：仓库菜单树 -->
            <div class="repository-section">
                <div class="repository-section-header">全量用例</div>
                <div class="menu-tree" id="repositoryMenuTree">
                    <!-- JavaScript 动态生成 -->
                </div>
            </div>

            <!-- 右侧：用例列表 + 详情 -->
            <div class="repository-testcase-section">
                <div class="repository-section-header">📋 用例列表</div>

                <div class="repository-testcase-toolbar">
                    <div style="color: #6b7280; font-size: 14px;">
                        当前菜单: <strong style="color: #374151;" id="repositoryCurrentMenuName">请选择菜单</strong>
                    </div>
                    <div class="repository-testcase-actions">
                        <button class="btn-small" onclick="selectAllRepositoryTestCases()">☑️ 全选</button>
                        <button class="btn-small" onclick="unselectAllRepositoryTestCases()">☐ 全不选</button>
                    </div>
                </div>

                <div class="repository-testcase-list-container">
                    <div class="repository-testcase-list" id="repositoryTestcaseList">
                        <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <div style="font-size: 64px; margin-bottom: 15px;">📋</div>
                            <p>请在左侧选择菜单查看用例</p>
                        </div>
                    </div>

                    <!-- 用例详情 -->
                    <div class="repository-testcase-detail" id="repositoryTestcaseDetail" style="display: none;">
                        <!-- JavaScript 动态生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部统计 -->
        <div class="repository-selection-summary">
            <div class="repository-summary-stats">
                <div class="repository-stat-item">
                    <span style="color: #6b7280; font-size: 14px;">已选模块:</span>
                    <span style="color: #667eea; font-size: 20px; font-weight: bold; margin: 0 5px;" id="repositorySelectedMenuCount">0</span>
                    <span style="color: #6b7280; font-size: 14px;">个</span>
                </div>
                <div class="repository-stat-item">
                    <span style="color: #6b7280; font-size: 14px;">已选用例:</span>
                    <span style="color: #667eea; font-size: 20px; font-weight: bold; margin: 0 5px;" id="repositorySelectedTestCaseCount">0</span>
                    <span style="color: #6b7280; font-size: 14px;">条</span>
                </div>
            </div>
            <div style="color: #6b7280; font-size: 13px;">
                💡 点击"创建版本"将选中的模块和用例复制到首页
            </div>
        </div>
    </div>
</div>

<!-- 创建版本模态弹窗 -->
<div id="createVersionModal" class="create-version-modal" onclick="closeCreateVersionModalOnBackdrop(event)">
    <div class="create-version-modal-content" onclick="event.stopPropagation()">
        <div class="create-version-modal-header">
            <h3>🎯 创建新版本</h3>
            <button class="create-version-modal-close" onclick="closeCreateVersionModal()">×</button>
        </div>

        <div class="create-version-modal-body">
            <div class="create-version-form-group">
                <label class="create-version-form-label">版本名称 <span style="color: #ef4444;">*</span></label>
                <input
                    type="text"
                    id="versionNameInput"
                    class="create-version-form-input"
                    placeholder="请输入版本名称，例如：132回归用例"
                    maxlength="50"
                >
            </div>

            <div class="create-version-summary">
                <div class="create-version-summary-title">📊 选择统计</div>
                <div class="create-version-summary-item">
                    <span class="create-version-summary-label">已选模块：</span>
                    <span class="create-version-summary-value" id="modalSelectedMenuCount">0 个</span>
                </div>
                <div class="create-version-summary-item">
                    <span class="create-version-summary-label">已选用例：</span>
                    <span class="create-version-summary-value" id="modalSelectedTestCaseCount">0 条</span>
                </div>
            </div>
        </div>

        <div class="create-version-modal-footer">
            <button class="create-version-btn-cancel" onclick="closeCreateVersionModal()">取消</button>
            <button class="create-version-btn-confirm" onclick="confirmCreateVersion()">创建版本</button>
        </div>
    </div>
</div>

<script>
    // ========== 立即执行登录检查 ==========
    // 必须在所有代码执行前检查登录状态
    (function() {
        const token = localStorage.getItem('token');
        if (!token) {
            // 未登录，立即重定向到登录页
            window.location.href = 'index.html';
            // 阻止后续代码执行
            throw new Error('Not authenticated');
        }
    })();
    // ========================================

    let menus = []; // 一级菜单列表
    let testCases = [];
    let logs = []; // 操作日志列表
    let currentTestCase = null;
    let currentPlatform = 'android'; // 默认选择Android平台

    // 懒加载缓存
    const menuChildrenCache = {}; // 子菜单缓存 { parentId: [children] }
    const testCaseListCache = {}; // 测试用例列表缓存 { menuId: [testCases] }
    const testCaseDetailCache = {}; // 测试用例详情缓存 { testCaseId: testCase }
    let loadedTestCaseMenuIds = new Set(); // 已加载测试用例子菜单的menu ID集合
    let loadedSmokeMenuIds = new Set(); // 已加载冒烟用例子菜单的menu ID集合

    // 获取当前使用的 loadedMenuIds Set
    function getLoadedMenuIds() {
        return currentSidebarTab === 'smoke' ? loadedSmokeMenuIds : loadedTestCaseMenuIds;
    }
    let currentMenuId = null; // 当前右键点击的菜单ID
    let currentProjectName = null; // 当前右键点击的项目名称
    let currentProjectMenuId = null; // 当前项目所属的菜单ID
    let isEditMode = false; // 是否处于编辑模式
    let editingTestCase = null; // 正在编辑的测试用例副本
    let pendingFailStatus = false; // 是否有待处理的不通过状态
    let searchKeyword = ''; // 搜索关键词
    let searchResults = []; // 搜索结果
    let expandedTestCaseMenus = new Set(); // 保存测试用例展开的菜单ID
    let expandedSmokeMenus = new Set(); // 保存冒烟用例展开的菜单ID

    // 冒烟用例相关
    let currentSidebarTab = 'testcase'; // 当前侧边栏Tab
    let smokeMenus = []; // 冒烟用例菜单列表

    // ========== 执行进度弹窗类 ==========
    /**
     * 测试执行进度弹窗组件
     * 显示测试执行的详细步骤和实时进度
     */
    class ExecutionProgressModal {
        constructor(executionId, testCaseName, platform, mode = 'simple') {
            this.executionId = executionId;
            this.testCaseName = testCaseName;
            this.platform = platform;
            this.mode = mode;
            this.pollInterval = null;
            this.isRunning = true;

            // 定义8个标准步骤
            this.steps = [
                { id: 1, title: '检查设备连接', description: '验证测试设备连接状态', status: 'pending', duration: null },
                { id: 2, title: '检查APP安装状态', description: '检查目标APP是否已安装', status: 'pending', duration: null },
                { id: 3, title: '启动APP并初始化', description: '启动Appium和目标应用', status: 'pending', duration: null },
                { id: 4, title: '解析测试用例', description: '识别自动化级别和测试步骤', status: 'pending', duration: null },
                { id: 5, title: '执行前置条件', description: '准备测试环境和数据', status: 'pending', duration: null },
                { id: 6, title: '执行测试步骤', description: '按照用例步骤执行操作', status: 'pending', duration: null },
                { id: 7, title: '验证预期结果', description: '对比实际结果与预期结果', status: 'pending', duration: null },
                { id: 8, title: '保存测试结果', description: '上传截图和执行日志', status: 'pending', duration: null }
            ];

            this.create();
        }

        create() {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay execution-progress-overlay';
            overlay.innerHTML = this.getHTML();
            document.body.appendChild(overlay);

            this.overlay = overlay;
            this.bindEvents();
        }

        getHTML() {
            return `
                <div class="execution-modal">
                    <div class="modal-header">
                        <div class="modal-title">
                            <span class="icon rotating">⚙️</span>
                            <span>测试执行中...</span>
                        </div>
                        <button class="close-btn" onclick="window.currentProgressModal?.hide()">×</button>
                    </div>

                    <div class="test-case-info">
                        <div class="test-case-name">${this.testCaseName}</div>
                        <div class="test-case-meta">
                            <div class="meta-item">
                                <span>${this.getPlatformIcon()}</span>
                                <span>${this.getPlatformName()}</span>
                            </div>
                            <div class="meta-item">
                                <span>📋</span>
                                <span>${this.getModeName()}</span>
                            </div>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="overall-progress">
                            <div class="progress-header">
                                <div class="progress-label">整体进度</div>
                                <div class="progress-percentage">0%</div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="steps-list"></div>
                    </div>

                    <div class="modal-footer">
                        <div class="status-badge running">⚙️ 执行中</div>
                        <div class="action-buttons">
                            <button class="btn btn-cancel" onclick="window.currentProgressModal?.cancel()">取消执行</button>
                        </div>
                    </div>
                </div>
            `;
        }

        bindEvents() {
            // ESC键关闭
            this.escHandler = (e) => {
                if (e.key === 'Escape' && !this.isRunning) {
                    this.hide();
                }
            };
            document.addEventListener('keydown', this.escHandler);
        }

        show() {
            this.overlay.style.display = 'flex';
            this.render();
            this.startPolling();
            window.currentProgressModal = this;
        }

        hide() {
            this.stopPolling();
            this.overlay.remove();
            document.removeEventListener('keydown', this.escHandler);
            window.currentProgressModal = null;
        }

        async cancel() {
            if (!confirm('确定要取消执行吗？')) return;

            try {
                await apiService.request(`/test-executions/${this.executionId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        status: 'cancelled',
                        result: 'cancelled'
                    })
                });

                this.isRunning = false;
                this.updateStatus('cancelled');
                this.hide();
            } catch (error) {
                console.error('取消执行失败:', error);
                alert('取消失败: ' + error.message);
            }
        }

        startPolling() {
            this.fetchProgress();  // 立即获取一次
            this.pollInterval = setInterval(() => {
                this.fetchProgress();
            }, 2000);  // 每2秒轮询
        }

        stopPolling() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
            }
        }

        async fetchProgress() {
            try {
                // 获取执行状态
                const response = await apiService.request(`/test-executions/${this.executionId}`);

                if (response.success) {
                    const execution = response.execution || response.data;

                    // 更新状态
                    if (execution.status === 'completed' || execution.status === 'failed') {
                        this.isRunning = false;
                        this.stopPolling();
                        this.updateStatus(execution.status, execution);
                    } else if (execution.status === 'running') {
                        // 根据日志推断进度
                        this.inferProgressFromLogs(execution.logs || []);
                    }
                }
            } catch (error) {
                console.error('获取进度失败:', error);
            }
        }

        inferProgressFromLogs(logs) {
            /**
             * 根据日志内容推断执行进度
             * 这是一个简化方案，实际应该通过专门的进度API
             */
            const logText = logs.join('\n').toLowerCase();

            const checkpoints = [
                { step: 1, keywords: ['检查设备', 'device', 'adb devices'] },
                { step: 2, keywords: ['检查app', 'app安装', 'pm list packages'] },
                { step: 3, keywords: ['启动app', 'appium', 'webdriver'] },
                { step: 4, keywords: ['解析', '识别', 'automation_level'] },
                { step: 5, keywords: ['前置条件', 'precondition'] },
                { step: 6, keywords: ['执行步骤', '执行操作', 'execute step'] },
                { step: 7, keywords: ['验证', 'verify', 'assert'] },
                { step: 8, keywords: ['保存结果', '上传', 'save result'] }
            ];

            checkpoints.forEach(checkpoint => {
                const matched = checkpoint.keywords.some(keyword =>
                    logText.includes(keyword)
                );

                if (matched) {
                    this.updateStep(checkpoint.step, 'completed');
                }
            });

            this.render();
            this.updateOverallProgress();
        }

        updateStep(stepId, status, details = {}) {
            const step = this.steps.find(s => s.id === stepId);
            if (step) {
                step.status = status;
                if (details.duration) step.duration = details.duration;
                if (details.message) step.message = details.message;
            }
        }

        updateStatus(status, execution = {}) {
            const statusBadge = this.overlay.querySelector('.status-badge');
            const actionButtons = this.overlay.querySelector('.action-buttons');

            if (status === 'completed') {
                // 全部标记为完成
                this.steps.forEach(step => {
                    if (step.status !== 'completed') {
                        step.status = 'completed';
                    }
                });

                statusBadge.className = 'status-badge completed';
                statusBadge.innerHTML = '✓ 测试完成';

                actionButtons.innerHTML = '<button class="btn btn-view-result" onclick="window.currentProgressModal?.viewResult()">查看详细报告</button>';

            } else if (status === 'failed') {
                statusBadge.className = 'status-badge failed';
                statusBadge.innerHTML = '✗ 测试失败';

                actionButtons.innerHTML = '<button class="btn btn-view-result" onclick="window.currentProgressModal?.viewResult()">查看错误详情</button>';
            }

            this.render();
            this.updateOverallProgress();
        }

        viewResult() {
            this.hide();
            // 跳转到结果详情页或显示结果弹窗
            console.log('查看结果:', this.executionId);
        }

        updateOverallProgress() {
            const completed = this.steps.filter(s => s.status === 'completed').length;
            const total = this.steps.length;
            const percentage = Math.round((completed / total) * 100);

            const percentageEl = this.overlay.querySelector('.progress-percentage');
            const progressBar = this.overlay.querySelector('.progress-bar');

            if (percentageEl) percentageEl.textContent = `${percentage}%`;
            if (progressBar) progressBar.style.width = `${percentage}%`;
        }

        render() {
            const stepsList = this.overlay.querySelector('.steps-list');
            if (!stepsList) return;

            const html = this.steps.map(step => `
                <div class="step-item ${step.status}">
                    <div class="step-header">
                        <div class="step-icon">${this.getStepIcon(step.status)}</div>
                        <div class="step-title">${step.title}</div>
                        <div class="step-time">${this.getStepTime(step)}</div>
                    </div>
                    ${step.description ? `
                        <div class="step-description">${step.description}</div>
                    ` : ''}
                    ${step.message ? `
                        <div class="step-detail">${step.message}</div>
                    ` : ''}
                </div>
            `).join('');

            stepsList.innerHTML = html;
        }

        getStepIcon(status) {
            const icons = {
                'pending': '○',
                'running': '⚙️',
                'completed': '✓',
                'error': '✗'
            };
            return icons[status] || '○';
        }

        getStepTime(step) {
            if (step.status === 'pending') return '等待中';
            if (step.status === 'running') return '进行中...';
            if (step.duration) return `${step.duration}s`;
            return '';
        }

        getPlatformIcon() {
            const icons = {
                'android': '📱',
                'ios': '🍎',
                'h5': '🌐'
            };
            return icons[this.platform] || '📱';
        }

        getPlatformName() {
            const names = {
                'android': 'Android',
                'ios': 'iOS',
                'h5': 'H5'
            };
            return names[this.platform] || this.platform;
        }

        getModeName() {
            const names = {
                'simple': 'Simple模式',
                'standard': 'Standard模式',
                'script': 'Script模式'
            };
            return names[this.mode] || 'Simple模式';
        }
    }

    // 导出供全局使用
    window.ExecutionProgressModal = ExecutionProgressModal;

    // 获取当前使用的 expandedMenus Set
    function getExpandedMenus() {
        return currentSidebarTab === 'smoke' ? expandedSmokeMenus : expandedTestCaseMenus;
    }

    // TAB 切换函数
    function switchTab(tabName) {
        // 移除所有active类
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // 添加active类到当前tab
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');

        // 如果切换到数据管理TAB，更新统计数据
        if (tabName === 'data') {
            updateStats();
        }

        // 如果切换到用例仓库TAB，初始化仓库数据
        if (tabName === 'repository') {
            initRepositoryTab();
        }
    }

    // Loading 显示和隐藏函数
    function showLoading(message = '正在加载...', showCancelBtn = false) {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        const cancelBtn = document.getElementById('loadingCancelBtn');

        if (text) text.textContent = message;
        if (cancelBtn) cancelBtn.style.display = showCancelBtn ? 'block' : 'none';
        if (overlay) overlay.style.display = 'flex';
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        const cancelBtn = document.getElementById('loadingCancelBtn');

        if (overlay) overlay.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'none';
    }

    // 侧边栏Tab切换
    function switchSidebarTab(tab) {
        currentSidebarTab = tab;

        // 更新按钮状态
        document.querySelectorAll('.sidebar-tab').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tab) {
                btn.classList.add('active');
            }
        });

        // 切换内容
        document.getElementById('testcaseMenuContent').style.display =
            tab === 'testcase' ? 'block' : 'none';
        document.getElementById('smokeMenuContent').style.display =
            tab === 'smoke' ? 'block' : 'none';

        if (tab === 'smoke') {
            loadSmokeMenus();  // 每次切换都重新加载，确保数据最新
        }
    }

    // 加载冒烟菜单
    async function loadSmokeMenus() {
        try {
            showLoading('加载冒烟用例菜单...');
            const result = await apiService.getSmokeMenus(1);

            if (result && result.success) {
                smokeMenus = result.data || [];
            } else {
                smokeMenus = [];  // API失败时设置为空数组
            }
            renderSmokeMenuList();
        } catch (error) {
            console.error('加载冒烟菜单失败:', error);
            smokeMenus = [];  // 异常时设置为空数组
            renderSmokeMenuList();
            showToast('加载失败: ' + (error.message || '未知错误'));
        } finally {
            hideLoading();
        }
    }

    // 渲染冒烟菜单列表
    function renderSmokeMenuList() {
        const smokeList = document.getElementById('smokeProjectList');

        // 保存当前展开的菜单状态（使用菜单ID）
        expandedSmokeMenus.clear();

        // 保存展开的菜单
        const currentExpandedMenus = smokeList.querySelectorAll('.menu-content[style*="display: block"]');
        currentExpandedMenus.forEach(content => {
            const menuDiv = content.previousElementSibling;
            if (menuDiv && menuDiv.dataset.menuId) {
                expandedSmokeMenus.add(menuDiv.dataset.menuId);
            }
        });

        // 保存展开的项目分组
        const currentExpandedProjects = smokeList.querySelectorAll('.test-case-list[style*="display: block"]');
        currentExpandedProjects.forEach(caseList => {
            const projectDiv = caseList.previousElementSibling;
            if (projectDiv && projectDiv.dataset.projectKey) {
                expandedSmokeMenus.add(projectDiv.dataset.projectKey);
            }
        });

        // 清空已加载状态（DOM重建后需要重新懒加载）
        console.log('[清空缓存标记] loadedSmokeMenuIds 已清空，但缓存数据保留');
        console.log('[缓存数据] menuChildrenCache keys:', Object.keys(menuChildrenCache).filter(k => k.startsWith('smoke_')));
        console.log('[缓存数据] testCaseListCache keys:', Object.keys(testCaseListCache).filter(k => k.startsWith('smoke_')));
        loadedSmokeMenuIds.clear();

        smokeList.innerHTML = '';

        if (smokeMenus.length === 0) {
            smokeList.innerHTML = `<div style="padding: 20px; text-align: center; color: #999;">
                暂无冒烟用例<br/>上传包含P0用例的测试文件后自动生成
            </div>`;
            return;
        }

        // 构建菜单树（与测试用例一致）
        const smokeMenuTree = buildMenuTree(smokeMenus);

        // 渲染所有根菜单
        smokeMenuTree.forEach(rootMenu => {
            const menuElement = renderMenuNode(rootMenu, 1, true);
            if (menuElement) {
                smokeList.appendChild(menuElement);
            }
        });
    }

    // 显示加载错误提示
    function showLoadError() {
        hideLoading(); // 先隐藏加载动画
        const errorOverlay = document.getElementById('loadErrorOverlay');
        if (errorOverlay) {
            errorOverlay.style.display = 'flex';
        }
    }

    // 隐藏加载错误提示
    function hideLoadError() {
        const errorOverlay = document.getElementById('loadErrorOverlay');
        if (errorOverlay) {
            errorOverlay.style.display = 'none';
        }
    }

    // 重新加载数据
    async function retryLoadData() {
        hideLoadError(); // 隐藏错误提示
        await loadFromLocalStorage(); // 重新加载
    }

    // 将字符串或JSON转换为数组的辅助函数
    function parseToArray(value) {
        if (!value) return [];
        if (Array.isArray(value)) return value;

        // 尝试解析 JSON
        if (typeof value === 'string') {
            try {
                const parsed = JSON.parse(value);
                if (Array.isArray(parsed)) return parsed;
            } catch (e) {
                // 不是 JSON，按换行符分割
                return value.split('\n').filter(line => line.trim());
            }
        }

        return [String(value)];
    }

    // 文件上传处理
    document.getElementById('fileInput').addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!currentMenuId) {
            alert('请先右键点击菜单，然后上传测试用例');
            return;
        }

        let uploadSuccess = false;

        try {
            showLoading(`正在上传 ${file.name}，请耐心等待...`);

            // 调用 API 上传文件（后端会解析文件）
            // 设置5分钟超时，适合大量用例上传
            const result = await apiService.uploadTestCases(currentMenuId, file, {
                timeout: 300000,  // 5分钟超时
                onProgress: (progress) => {
                    if (progress.status === 'retrying') {
                        showLoading(`上传失败，正在重试 (${progress.attempt}/${progress.total})...`);
                    }
                }
            });

            uploadSuccess = true;

            // 清除所有缓存（因为新上传的用例可能影响所有菜单的统计数据）
            clearCache();

            // 重新加载数据
            showLoading('上传成功，正在刷新数据...');
            await loadFromLocalStorage();

            // 记录日志
            const currentMenu = menus.find(m => m.id === currentMenuId);
            const menuName = currentMenu ? currentMenu.name : '未知菜单';
            const fileType = file.name.split('.').pop().toUpperCase();
            const importedCount = result.data.test_cases_imported || result.data.imported_count || 0;
            const p0Count = result.data.p0_cases_synced || 0;
            addLog('上传测试用例', `文件: ${file.name}, 类型: ${fileType}, 菜单: ${menuName}, 导入用例数: ${importedCount}, P0用例: ${p0Count}`);

            hideLoading();
            showToast(result.message || `测试用例上传成功，共导入 ${importedCount} 条用例，其中${p0Count}个P0用例已同步`);

        } catch (error) {
            console.error('文件上传错误:', error);

            hideLoading();

            // 提供更详细的错误提示和重试建议
            let errorMessage = '文件上传失败：' + error.message;

            if (error.message.includes('超时')) {
                errorMessage += '\n\n建议：\n1. 检查网络连接\n2. 尝试减少用例数量\n3. 重新上传文件';
            } else if (error.message.includes('网络') || error.message.includes('连接')) {
                errorMessage += '\n\n建议：\n1. 检查网络连接\n2. 稍后重试';
            }

            alert(errorMessage);

        } finally {
            // 确保无论成功还是失败，都会执行清理操作
            // 重置文件输入，允许重新选择同一个文件
            e.target.value = '';

            // 如果加载框还在显示，确保关闭它
            if (!uploadSuccess) {
                hideLoading();
            }
        }
    });

    // 保存到localStorage
    function saveToLocalStorage() {
        try {
            const data = {
                menus: menus,
                testCases: testCases,
                logs: logs
            };
            localStorage.setItem('testCaseData', JSON.stringify(data));
        } catch (e) {
            console.error('保存到localStorage失败:', e);
            showToast('数据保存失败');
        }
    }

    // 从API加载数据（优化：只加载一级菜单）
    async function loadFromLocalStorage() {
        try {
            showLoading('正在加载数据...');

            // 只加载一级菜单（懒加载优化）
            const result = await apiService.getMenusByLevel(1);

            if (!result || !result.success) {
                throw new Error('加载菜单失败');
            }

            // 更新全局变量（只有一级菜单）
            menus = result.data || [];
            testCases = []; // 不再一次性加载所有测试用例
            logs = [];

            // 渲染页面
            renderMenuList();
            updateSearchMenuFilter(); // 更新搜索菜单过滤器
            updateStats();
            hideLoading();
            hideLoadError(); // 加载成功，确保隐藏错误提示

            console.log(`✅ 首页加载完成，加载了 ${menus.length} 个一级菜单`);
            return true;
        } catch (e) {
            console.error('加载数据失败:', e);

            // 检查是否是 401 未授权错误（token 过期）
            if (e.code === 'UNAUTHORIZED' || e.status === 401) {
                // 清除本地存储的认证信息
                localStorage.removeItem('token');
                localStorage.removeItem('user');

                // 提示用户并跳转到登录页
                alert('登录已过期，请重新登录');
                window.location.href = 'index.html';
                return false;
            }

            // 其他错误显示错误提示（带重新加载按钮）
            showLoadError();
            return false;
        }
    }

    // 清除缓存（在增删改操作后调用）
    function clearCache(menuId = null) {
        if (menuId) {
            delete menuChildrenCache[menuId];
            delete testCaseListCache[menuId];
            getLoadedMenuIds().delete(menuId);
        } else {
            // 清除所有缓存
            Object.keys(menuChildrenCache).forEach(key => delete menuChildrenCache[key]);
            Object.keys(testCaseListCache).forEach(key => delete testCaseListCache[key]);
            Object.keys(testCaseDetailCache).forEach(key => delete testCaseDetailCache[key]);
            getLoadedMenuIds().clear();
        }
    }

    // 懒加载子菜单
    async function loadMenuChildren(menuId, isSmokeMenu = false) {
        // 如果已经加载过，直接返回缓存
        const cacheKey = isSmokeMenu ? `smoke_${menuId}` : menuId;
        if (menuChildrenCache[cacheKey]) {
            console.log(`[缓存命中] 子菜单缓存 - ${isSmokeMenu ? '冒烟' : '测试用例'} - cacheKey: ${cacheKey}, 子菜单数: ${menuChildrenCache[cacheKey].length}`);
            const cachedChildren = menuChildrenCache[cacheKey];
            // 即使从缓存返回，也要确保子菜单在全局数组中
            const targetArray = isSmokeMenu ? smokeMenus : menus;
            cachedChildren.forEach(childMenu => {
                if (!targetArray.find(m => m.id === childMenu.id)) {
                    targetArray.push(childMenu);
                }
            });
            return cachedChildren;
        }
        console.log(`[缓存未命中] 调用API加载子菜单 - ${isSmokeMenu ? '冒烟' : '测试用例'} - menuId: ${menuId}`);

        try {
            // 冒烟菜单调用冒烟子菜单API，普通菜单调用普通子菜单API
            const result = isSmokeMenu
                ? await apiService.getSmokeMenuChildren(menuId)
                : await apiService.getMenuChildren(menuId);

            if (result && result.success) {
                menuChildrenCache[cacheKey] = result.data || [];
                // 将子菜单添加到对应的全局数组中
                const targetArray = isSmokeMenu ? smokeMenus : menus;
                result.data.forEach(childMenu => {
                    if (!targetArray.find(m => m.id === childMenu.id)) {
                        targetArray.push(childMenu);
                    }
                });
                return menuChildrenCache[cacheKey];
            }
            return [];
        } catch (error) {
            console.error('加载子菜单失败:', error);
            return [];
        }
    }

    // 懒加载测试用例列表
    async function loadTestCaseList(menuId, isSmokeMenu = false) {
        // 如果已经加载过，直接返回缓存
        const cacheKey = isSmokeMenu ? `smoke_${menuId}` : menuId;
        if (testCaseListCache[cacheKey]) {
            const cachedCases = testCaseListCache[cacheKey];
            console.log(`[缓存命中] 测试用例缓存 - ${isSmokeMenu ? '冒烟' : '测试用例'} - cacheKey: ${cacheKey}, 用例数: ${cachedCases.length}`);
            // 即使从缓存返回，也要确保这些用例在全局 testCases 数组中
            // 这样重新渲染时才能正确显示
            cachedCases.forEach(tc => {
                const existingIndex = testCases.findIndex(t => t.id === tc.id);
                if (existingIndex >= 0) {
                    testCases[existingIndex] = tc;
                } else {
                    testCases.push(tc);
                }
            });
            return cachedCases;
        }
        console.log(`[缓存未命中] 调用API加载测试用例 - ${isSmokeMenu ? '冒烟' : '测试用例'} - menuId: ${menuId}`);

        try {
            // 冒烟菜单调用冒烟用例API，普通菜单调用普通测试用例API
            const result = isSmokeMenu
                ? await apiService.getSmokeTestCasesByMenu(menuId)
                : await apiService.getTestCasesByMenu(menuId);

            if (result && result.success) {
                const cases = (result.data || []).map(tc => ({
                    id: tc.id,
                    menuId: tc.menu_id,
                    project: tc.project,
                    name: tc.name,
                    androidStatus: tc.android_status,
                    androidFailReason: tc.android_fail_reason || '',
                    iosStatus: tc.ios_status,
                    iosFailReason: tc.ios_fail_reason || '',
                    h5Status: tc.h5_status,
                    h5FailReason: tc.h5_fail_reason || '',
                    // 冒烟用例特有字段
                    originalTestCaseId: tc.original_test_case_id,
                    // 详情字段暂时不加载，等点击时再加载
                    preconditions: [],
                    steps: [],
                    expectedResults: []
                }));
                testCaseListCache[cacheKey] = cases;
                // 将测试用例添加到全局testCases数组中
                cases.forEach(tc => {
                    const existingIndex = testCases.findIndex(t => t.id === tc.id);
                    if (existingIndex >= 0) {
                        testCases[existingIndex] = tc;
                    } else {
                        testCases.push(tc);
                    }
                });
                return cases;
            }
            return [];
        } catch (error) {
            console.error('加载测试用例列表失败:', error);
            return [];
        }
    }

    // 懒加载测试用例详情
    async function loadTestCaseDetail(testCaseId, isSmokeTestCase = false) {
        // 如果已经加载过，直接返回缓存
        if (testCaseDetailCache[testCaseId]) {
            return testCaseDetailCache[testCaseId];
        }

        try {
            // 根据是否为冒烟用例调用不同的API
            const result = isSmokeTestCase
                ? await apiService.getSmokeTestCaseDetail(testCaseId)
                : await apiService.getTestCaseDetail(testCaseId);

            if (result && result.success) {
                const tc = result.data;
                const detail = {
                    id: tc.id,
                    menuId: tc.menu_id,
                    project: tc.project,
                    name: tc.name,
                    preconditions: parseToArray(tc.preconditions),
                    steps: parseToArray(tc.steps),
                    expectedResults: parseToArray(tc.expected_results),
                    androidStatus: tc.android_status,
                    androidFailReason: tc.android_fail_reason || '',
                    iosStatus: tc.ios_status,
                    iosFailReason: tc.ios_fail_reason || '',
                    h5Status: tc.h5_status,
                    h5FailReason: tc.h5_fail_reason || '',
                    // 冒烟用例特有字段
                    originalTestCaseId: tc.original_test_case_id
                };
                testCaseDetailCache[testCaseId] = detail;
                // 更新全局testCases数组
                const existingIndex = testCases.findIndex(t => t.id === testCaseId);
                if (existingIndex >= 0) {
                    testCases[existingIndex] = detail;
                } else {
                    testCases.push(detail);
                }
                return detail;
            }
            return null;
        } catch (error) {
            console.error('加载测试用例详情失败:', error);
            return null;
        }
    }

    // 数据迁移：将旧格式(status)转换为新格式(androidStatus/iosStatus)
    function migrateTestCaseData() {
        testCases.forEach(tc => {
            if (tc.status !== undefined && (tc.androidStatus === undefined || tc.iosStatus === undefined)) {
                // 旧格式数据，迁移到新格式
                tc.androidStatus = tc.status || 'pending';
                tc.iosStatus = tc.status || 'pending';
                delete tc.status;
            } else if (tc.androidStatus === undefined) {
                tc.androidStatus = 'pending';
            }
            if (tc.iosStatus === undefined) {
                tc.iosStatus = 'pending';
                tc.h5Status = 'pending';
            }

            // 确保有不通过原因字段
            if (tc.androidFailReason === undefined) {
                tc.androidFailReason = '';
            }
            if (tc.iosFailReason === undefined) {
                tc.iosFailReason = '';
            }
            if (tc.h5FailReason === undefined) {
                tc.h5FailReason = '';
            }
        });
    }

    // 解析Excel文件
    async function parseExcelFile(file) {
        try {
            addLog('开始解析Excel', `文件名: ${file.name}, 大小: ${(file.size / 1024).toFixed(2)} KB`);

            const reader = new FileReader();

            const data = await new Promise((resolve, reject) => {
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsBinaryString(file);
            });

            // 使用 XLSX 库解析
            const workbook = XLSX.read(data, { type: 'binary' });

            // 获取第一个工作表
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];

            // 转换为JSON数组（保留空单元格）
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

            console.log('📄 Excel文件信息:');
            console.log('  工作表名称:', sheetName);
            console.log('  读取到的行数:', rows.length);
            console.log('  第一行数据示例:', rows[0]);

            addLog('Excel文件读取成功', `工作表: ${sheetName}, 总行数: ${rows.length}`);

            // 解析Excel内容为测试用例
            const testCases = parseExcelContent(rows, file.name);

            return testCases;
        } catch (error) {
            console.error('Excel文件解析错误:', error);
            addLog('Excel解析失败', `错误信息: ${error.message}`);
            throw new Error('Excel文件解析失败: ' + error.message);
        }
    }

    // 解析Excel内容（按*和**标识识别层级）
    function parseExcelContent(rows, fileName) {
        console.log('========== Excel解析开始 ==========');
        console.log('总行数:', rows.length);
        addLog('开始解析Excel内容', `开始逐行解析, 总行数: ${rows.length}`);

        const testCases = [];
        let tcIndex = 1;
        let currentProject = ''; // 当前项目名称（*标识）
        let currentTestCase = null; // 当前测试用例（**标识）
        let currentSection = null; // 当前章节（前置条件/操作步骤/预期结果）

        // 统计信息
        let projectCount = 0;
        let testCaseCount = 0;
        let contentLines = 0;

        
        // 表格格式检测：检测列头映射
        let tableFormat = null; // {preconditionsCol, stepsCol, expectedResultsCol, testCaseCol}
        let tableHeaderRow = -1;

        // 检测前几行是否包含表头
        for (let i = 0; i < Math.min(5, rows.length); i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;

            // 检查是否包含典型的表头关键词
            const colMapping = {};
            let hasTableHeader = false;

            for (let j = 0; j < row.length; j++) {
                const cell = (row[j] || '').toString().trim().toLowerCase();

                // 识别各列
                if (cell.includes('前置条件') || cell.includes('前置') || cell === '前置' || cell.includes('precondition')) {
                    colMapping.preconditionsCol = j;
                    hasTableHeader = true;
                } else if (cell.includes('测试步骤') || cell.includes('操作步骤') || cell.includes('执行步骤') || cell === '步骤' || cell.includes('step')) {
                    colMapping.stepsCol = j;
                    hasTableHeader = true;
                } else if (cell.includes('预期结果') || cell.includes('期望结果') || cell === '预期' || cell === '结果' || cell.includes('expected')) {
                    colMapping.expectedResultsCol = j;
                    hasTableHeader = true;
                } else if (cell.includes('测试项') || cell.includes('用例名') || cell.includes('测试用例') || cell.includes('case name')) {
                    colMapping.testCaseCol = j;
                }
            }

            // 如果至少有2个章节列，认为是表格格式
            const sectionCols = [colMapping.preconditionsCol, colMapping.stepsCol, colMapping.expectedResultsCol].filter(c => c !== undefined);
            if (sectionCols.length >= 2) {
                tableFormat = colMapping;
                tableHeaderRow = i;
                console.log('✓ 检测到表格格式Excel，表头行:', i + 1);
                console.log('  列映射:', colMapping);
                addLog('Excel格式检测', `检测到表格格式，表头在第${i+1}行，列映射: 前置${colMapping.preconditionsCol}列 步骤${colMapping.stepsCol}列 结果${colMapping.expectedResultsCol}列`);
                break;
            }
        }
for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;

            // 全文搜索：收集当前行所有非空单元格
            const allCells = [];
            for (let j = 0; j < row.length; j++) {
                if (row[j] && row[j].toString().trim()) {
                    const cellContent = row[j].toString()
                        .replace(/\s+/g, ' ')  // 将多个空白字符替换为单个空格
                        .trim();
                    allCells.push({ content: cellContent, colIndex: j });
                }
            }

            if (allCells.length === 0) continue;

            // 输出前20行的所有单元格内容用于调试
            if (i < 20) {
                const cellsPreview = allCells.map(c => `[列${c.colIndex}]${c.content.substring(0, 30)}`).join(' | ');
                console.log(`第${i + 1}行:`, cellsPreview);
            }

            // 识别标识和内容：遍历所有单元格查找 * 或 ** 标识
            const starPattern = /^[*＊]{2,}/;
            const singleStarPattern = /^[*＊]{1}(?![*＊])/;

            let foundMarker = false;

            // 优先查找 ** 标识（测试用例名称）
            for (const cell of allCells) {
                if (starPattern.test(cell.content)) {
                    // 保存上一个测试用例
                    if (currentTestCase) {
                        testCases.push(currentTestCase);
                    }

                    // 创建新的测试用例
                    const testCaseName = cell.content.replace(/^[*＊]+\s*/, '').trim();
                    currentTestCase = {
                        id: 'TC' + tcIndex.toString().padStart(3, '0'),
                        project: currentProject || '未命名项目',
                        name: testCaseName || '未命名测试用例',
                        preconditions: [],
                        steps: [],
                        expectedResults: [],
                        androidStatus: 'pending',
                        iosStatus: 'pending',
                        h5Status: 'pending'
                    };
                    testCaseCount++;
                    console.log(`  ✓ 发现测试用例 [${testCaseCount}] 在列${cell.colIndex}:`, testCaseName, '(项目:', currentProject, ')');
                    addLog('Excel解析-发现测试用例', `第${testCaseCount}个用例, 名称: ${testCaseName}, 项目: ${currentProject}, 位置: 第${i+1}行第${cell.colIndex}列`);
                    tcIndex++;
                    currentSection = null;
                    foundMarker = true;

                    // 如果是表格格式，从当前行提取前置条件、步骤和结果
                    if (tableFormat && i > tableHeaderRow) {
                        // 提取前置条件
                        if (tableFormat.preconditionsCol !== undefined && row[tableFormat.preconditionsCol]) {
                            const preconditionsText = row[tableFormat.preconditionsCol].toString().trim();
                            if (preconditionsText) {
                                // 按换行符分割
                                const items = preconditionsText.split(/\n|;|；/).map(item => item.trim()).filter(item => item);
                                currentTestCase.preconditions.push(...items);
                                console.log(`    ✓ 表格模式：提取到前置条件 ${items.length} 条`);
                            }
                        }

                        // 提取测试步骤
                        if (tableFormat.stepsCol !== undefined && row[tableFormat.stepsCol]) {
                            const stepsText = row[tableFormat.stepsCol].toString().trim();
                            if (stepsText) {
                                // 按换行符或数字序号分割
                                const items = stepsText.split(/\n|;|；/).map(item => item.trim()).filter(item => item);
                                currentTestCase.steps.push(...items);
                                console.log(`    ✓ 表格模式：提取到测试步骤 ${items.length} 条`);
                            }
                        }

                        // 提取预期结果
                        if (tableFormat.expectedResultsCol !== undefined && row[tableFormat.expectedResultsCol]) {
                            const resultsText = row[tableFormat.expectedResultsCol].toString().trim();
                            if (resultsText) {
                                // 按换行符分割
                                const items = resultsText.split(/\n|;|；/).map(item => item.trim()).filter(item => item);
                                currentTestCase.expectedResults.push(...items);
                                console.log(`    ✓ 表格模式：提取到预期结果 ${items.length} 条`);
                            }
                        }
                    }

                    break;
                }
            }

            if (foundMarker) continue;

            // 查找 * 标识（项目名称/需求名称）
            for (const cell of allCells) {
                if (singleStarPattern.test(cell.content)) {
                    // 保存上一个测试用例
                    if (currentTestCase) {
                        testCases.push(currentTestCase);
                        currentTestCase = null;
                    }

                    // 提取项目名称（去掉*号和空格）
                    currentProject = cell.content.replace(/^[*＊]+\s*/, '').trim();
                    projectCount++;
                    console.log(`✓ 发现项目 [${projectCount}] 在列${cell.colIndex}:`, currentProject);
                    addLog('Excel解析-发现项目', `第${projectCount}个项目, 名称: ${currentProject}, 位置: 第${i+1}行第${cell.colIndex}列`);
                    foundMarker = true;
                    break;
                }
            }

            if (foundMarker) continue;

            // 如果当前有测试用例，识别章节和内容
            if (currentTestCase) {
                // 检查所有单元格，看是否有章节标题
                let foundSection = false;

                for (const cell of allCells) {
                    const originalContent = cell.content;
                    const lowerContent = originalContent.toLowerCase();

                    // 识别章节标题 - 大幅增强容错能力
                    // 前置条件的各种变体（更宽松的匹配）
                    if (lowerContent.includes('前置条件') ||
                        lowerContent.includes('前置') ||
                        lowerContent.includes('precondition') ||
                        lowerContent.includes('前提') ||
                        lowerContent.includes('准备') ||
                        lowerContent.includes('prerequisite') ||
                        lowerContent === '前置' ||
                        lowerContent.match(/^\s*前\s*置/) ||
                        lowerContent.match(/前\s*置/)) {
                        currentSection = 'preconditions';
                        console.log('    → 进入章节: 前置条件 (列' + cell.colIndex + ', 内容: "' + originalContent + '")');
                        addLog('Excel解析-识别章节', `章节: 前置条件, 用例: ${currentTestCase.name}, 位置: 第${i+1}行第${cell.colIndex}列`);
                        foundSection = true;
                        break;
                    }
                    // 操作步骤的各种变体（更宽松的匹配）
                    else if (lowerContent.includes('操作步骤') ||
                             lowerContent.includes('测试步骤') ||
                             lowerContent.includes('执行步骤') ||
                             lowerContent === '步骤' ||
                             lowerContent === '操作' ||
                             lowerContent.includes('step') ||
                             lowerContent.includes('测试过程') ||
                             lowerContent.includes('执行过程') ||
                             lowerContent.match(/^\s*步\s*骤/) ||
                             lowerContent.match(/^\s*操\s*作/)) {
                        currentSection = 'steps';
                        console.log('    → 进入章节: 操作步骤 (列' + cell.colIndex + ', 内容: "' + originalContent + '")');
                        addLog('Excel解析-识别章节', `章节: 操作步骤, 用例: ${currentTestCase.name}, 位置: 第${i+1}行第${cell.colIndex}列`);
                        foundSection = true;
                        break;
                    }
                    // 预期结果的各种变体（更宽松的匹配）
                    else if (lowerContent.includes('预期结果') ||
                             lowerContent.includes('期望结果') ||
                             lowerContent.includes('expected') ||
                             lowerContent === '预期' ||
                             lowerContent === '期望' ||
                             lowerContent === '结果' ||
                             lowerContent.includes('预期输出') ||
                             lowerContent.includes('期望输出') ||
                             lowerContent.includes('实际结果') ||
                             lowerContent.match(/^\s*预\s*期/) ||
                             lowerContent.match(/^\s*期\s*望/) ||
                             lowerContent.match(/预\s*期/) ||
                             lowerContent.match(/期\s*望/)) {
                        currentSection = 'expectedResults';
                        console.log('    → 进入章节: 预期结果 (列' + cell.colIndex + ', 内容: "' + originalContent + '")');
                        addLog('Excel解析-识别章节', `章节: 预期结果, 用例: ${currentTestCase.name}, 位置: 第${i+1}行第${cell.colIndex}列`);
                        foundSection = true;
                        break;
                    }
                }

                if (foundSection) continue;

                // 如果没有找到章节标题，将所有非空单元格作为内容添加到当前章节
                if (currentSection) {
                    for (const cell of allCells) {
                        // 清理内容（去掉序号、项目符号等）
                        let content = cell.content
                            .replace(/^[\d+\.\、\-•●○■□★☆►▶]+\s*/, '')  // 去掉各种序号和符号
                            .replace(/^[✓✔️❌×]\s*/, '')                 // 去掉勾选符号
                            .replace(/^[(（]\d+[)）]\s*/, '')            // 去掉括号序号如 (1) （1）
                            .replace(/^[a-zA-Z]\.\s*/, '')              // 去掉字母序号如 a. b.
                            .replace(/^第[一二三四五六七八九十\d]+[步条项点]\s*[、:：]?\s*/, '')  // 去掉中文序号
                            .trim();

                        if (content && content.length > 0) {
                            // 避免将章节标题作为内容添加进去
                            const lowerContent = content.toLowerCase();
                            const isSectionTitle = lowerContent.includes('前置条件') ||
                                                   lowerContent.includes('操作步骤') ||
                                                   lowerContent.includes('预期结果') ||
                                                   lowerContent === '前置' ||
                                                   lowerContent === '步骤' ||
                                                   lowerContent === '结果' ||
                                                   lowerContent === '预期' ||
                                                   lowerContent === '期望';

                            if (!isSectionTitle) {
                                currentTestCase[currentSection].push(content);
                                contentLines++;
                            }
                        }
                    }
                } else {
                    // 如果当前有测试用例但没有章节，输出警告
                    console.warn('    ⚠️  当前行有内容但没有章节标识，内容被忽略:', allCells.map(c => c.content.substring(0, 20)).join(' | '));
                }
            }
        }

        // 保存最后一个测试用例
        if (currentTestCase) {
            testCases.push(currentTestCase);
        }

        // 输出解析统计
        console.log('========== Excel解析完成 ==========');
        console.log('📊 解析统计:');
        console.log(`  - 发现项目数: ${projectCount}`);
        console.log(`  - 发现测试用例数: ${testCaseCount}`);
        console.log(`  - 添加的内容行数: ${contentLines}`);
        console.log(`  - 最终导入测试用例数: ${testCases.length}`);

        // 添加详细的日志记录
        addLog('Excel解析统计', `项目数: ${projectCount}, 测试用例数: ${testCaseCount}, 内容行数: ${contentLines}, 最终导入: ${testCases.length}条`);

        if (testCases.length === 0) {
            console.warn('⚠️ 警告: 未能解析出任何测试用例！');
            console.warn('可能的原因：');
            console.warn('  1. Excel文件中没有使用 * 和 ** 标识');
            console.warn('  2. 标识符位置不在单元格开头');
            console.warn('  3. Excel内容格式不符合要求');
            console.warn('请检查上面输出的前20行内容，确认格式是否正确');
            addLog('Excel解析警告', `未能解析出任何测试用例, 可能原因: 缺少*/**标识或格式不正确`);
        } else {
            console.log('✅ 成功解析测试用例，详细内容:');
            testCases.forEach((tc, idx) => {
                console.log(`  [${idx + 1}] ${tc.id} - ${tc.name} (${tc.project})`);
                console.log(`      前置条件: ${tc.preconditions.length}条, 操作步骤: ${tc.steps.length}条, 预期结果: ${tc.expectedResults.length}条`);
            });

            // 记录每个测试用例的详细信息
            const detailsList = testCases.map((tc, idx) =>
                `${idx + 1}. ${tc.id}-${tc.name}(项目:${tc.project}, 前置:${tc.preconditions.length}条, 步骤:${tc.steps.length}条, 结果:${tc.expectedResults.length}条)`
            ).join('; ');
            addLog('Excel解析成功', `成功解析 ${testCases.length} 条用例: ${detailsList}`);
        }
        console.log('====================================');

        return testCases;
    }

    // 解析XMind文件
    async function parseXmindFile(file) {
        try {
            // 使用JSZip解压xmind文件
            const zip = await JSZip.loadAsync(file);

            // 尝试读取content.json（XMind Zen格式）
            let content = null;
            if (zip.files['content.json']) {
                const contentStr = await zip.files['content.json'].async('string');
                content = JSON.parse(contentStr);
            }
            // 尝试读取content.xml（旧版XMind格式）
            else if (zip.files['content.xml']) {
                throw new Error('不支持旧版XMind格式（.xml），请使用XMind Zen版本保存');
            }
            else {
                throw new Error('无法找到XMind内容文件');
            }

            // 解析XMind内容为测试用例
            const testCases = parseXmindContent(content);
            return testCases;
        } catch (error) {
            console.error('XMind文件解析错误:', error);
            throw new Error('XMind文件解析失败: ' + error.message);
        }
    }

    // 解析XMind内容结构
    function parseXmindContent(content) {
        const testCases = [];
        let tcIndex = 1;

        // XMind Zen格式通常是一个数组，每个元素代表一个sheet
        const sheets = Array.isArray(content) ? content : [content];

        for (const sheet of sheets) {
            const rootTopic = sheet.rootTopic || sheet.topic;
            if (!rootTopic) continue;

            // 跳过根节点，直接从一级子节点（需求节点）开始
            if (!rootTopic.children || !rootTopic.children.attached) continue;

            // 遍历一级子节点（带*的需求名称）
            rootTopic.children.attached.forEach(requirementNode => {
                // 需求名称（去掉开头的*号和空格）
                let requirementName = (requirementNode.title || '').trim();
                requirementName = requirementName.replace(/^\*+\s*/, '');

                // 如果需求节点没有子节点，跳过
                if (!requirementNode.children || !requirementNode.children.attached) return;

                // 遍历二级子节点（带**的用例名称）
                requirementNode.children.attached.forEach(testCaseNode => {
                    // 用例名称（去掉开头的*号和空格）
                    let testCaseName = (testCaseNode.title || '').trim();
                    testCaseName = testCaseName.replace(/^\*+\s*/, '');

                    // 解析测试用例
                    const testCase = parseXmindTopic(testCaseNode, requirementName, testCaseName, tcIndex);
                    if (testCase) {
                        testCases.push(testCase);
                        tcIndex++;
                    }
                });
            });
        }

        return testCases;
    }

    // 解析单个XMind节点为测试用例
    function parseXmindTopic(topic, requirementName, testCaseName, index) {
        const testCase = {
            id: 'TC' + index.toString().padStart(3, '0'),
            project: requirementName || '未命名需求',
            name: testCaseName || '未命名测试用例',
            preconditions: [],
            steps: [],
            expectedResults: [],
            androidStatus: 'pending',
            iosStatus: 'pending',
            h5Status: 'pending'
        };

        // 如果没有子节点，返回简单的测试用例
        if (!topic.children || !topic.children.attached) {
            return testCase;
        }

        // 遍历三级子节点，识别前置条件、操作步骤、预期结果
        topic.children.attached.forEach(child => {
            const title = (child.title || '').trim();
            const lowerTitle = title.toLowerCase();

            // 判断节点类型
            if (lowerTitle.includes('前置条件') || lowerTitle.includes('precondition')) {
                // 提取前置条件的子节点
                if (child.children && child.children.attached) {
                    child.children.attached.forEach(item => {
                        if (item.title) {
                            testCase.preconditions.push(item.title.trim());
                        }
                    });
                }
            }
            else if (lowerTitle.includes('操作步骤') || lowerTitle.includes('步骤') || lowerTitle.includes('step')) {
                // 提取操作步骤的子节点
                if (child.children && child.children.attached) {
                    child.children.attached.forEach(item => {
                        if (item.title) {
                            testCase.steps.push(item.title.trim());
                        }
                    });
                }
            }
            else if (lowerTitle.includes('预期结果') || lowerTitle.includes('期望结果') || lowerTitle.includes('expected')) {
                // 提取预期结果的子节点
                if (child.children && child.children.attached) {
                    child.children.attached.forEach(item => {
                        if (item.title) {
                            testCase.expectedResults.push(item.title.replace(/^[✓✔️]\s*/, '').trim());
                        }
                    });
                }
            }
        });

        return testCase;
    }

    // 解析简化格式的测试用例
    function parseSimpleFormat(content) {
        const cases = [];
        // 用 --- 分隔不同的测试用例
        const blocks = content.split(/\n-{3,}\n/);

        blocks.forEach((block, index) => {
            const lines = block.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length === 0) return;

            const testCase = {
                id: 'TC' + (cases.length + 1).toString().padStart(3, '0'),
                project: '默认项目',
                name: '',
                preconditions: [],
                steps: [],
                expectedResults: [],
                androidStatus: 'pending',
                iosStatus: 'pending'
            };

            let currentSection = null;

            for (let line of lines) {
                // 匹配项目名称（可选）
                if (line.match(/^项目名称[:：]\s*(.+)/)) {
                    const match = line.match(/^项目名称[:：]\s*(.+)/);
                    testCase.project = match[1].trim();
                }
                // 匹配测试名称
                else if (line.match(/^测试名称[:：]\s*(.+)/)) {
                    const match = line.match(/^测试名称[:：]\s*(.+)/);
                    testCase.name = match[1].trim();
                }
                // 匹配章节标题
                else if (line.match(/^前置条件[:：]?$/)) {
                    currentSection = 'preconditions';
                } else if (line.match(/^操作步骤[:：]?$/)) {
                    currentSection = 'steps';
                } else if (line.match(/^预期结果[:：]?$/)) {
                    currentSection = 'expectedResults';
                }
                // 匹配列表内容
                else if (currentSection && line.match(/^[-•\d.]+\s*(.+)/)) {
                    const match = line.match(/^[-•\d.]+\s*(.+)/);
                    const content = match[1].trim();
                    if (content) {
                        testCase[currentSection].push(content);
                    }
                }
            }

            // 只有名称不为空才添加
            if (testCase.name) {
                cases.push(testCase);
            }
        });

        return cases;
    }

    // 解析Markdown格式的测试用例（兼容旧格式）
    function parseMarkdown(content) {
        // 先尝试简化格式
        const simpleCases = parseSimpleFormat(content);
        if (simpleCases.length > 0) {
            return simpleCases;
        }

        // 如果简化格式解析失败，尝试旧格式
        const cases = [];
        const lines = content.split('\n');
        let currentProject = null;
        let currentCase = null;
        let currentSection = null;

        for (let line of lines) {
            line = line.trim();

            // 匹配项目名称 (## 开头)
            if (line.match(/^##\s+(.+)/)) {
                const match = line.match(/^##\s+(.+)/);
                currentProject = match[1].replace(/特性/, '').trim();
            }

            // 匹配测试场景 (### 开头)
            else if (line.match(/^###\s+(.+)/)) {
                if (currentCase) {
                    cases.push(currentCase);
                }
                const match = line.match(/^###\s+(.+)/);
                currentCase = {
                    id: 'TC' + (cases.length + 1).toString().padStart(3, '0'),
                    project: currentProject || '未分类项目',
                    name: match[1].replace(/测试场景\d+\.\d+[：:]\s*/, ''),
                    preconditions: [],
                    steps: [],
                    expectedResults: [],
                    androidStatus: 'pending',
                    iosStatus: 'pending'
                };
                currentSection = null;
            }

            // 匹配章节
            else if (line.match(/^(\*\*)?【?前置条件】?(\*\*)?[:：]?/)) {
                currentSection = 'preconditions';
            } else if (line.match(/^(\*\*)?【?操作步骤】?(\*\*)?[:：]?/)) {
                currentSection = 'steps';
            } else if (line.match(/^(\*\*)?【?预期结果】?(\*\*)?[:：]?/)) {
                currentSection = 'expectedResults';
            }

            // 添加内容到当前章节
            else if (currentCase && currentSection && line.match(/^[-•\d.]+\s*(.+)/)) {
                const match = line.match(/^[-•\d.]+\s*(.+)/);
                const content = match[1].replace(/^[✓✔️]\s*/, '').trim();
                if (content) {
                    currentCase[currentSection].push(content);
                }
            }
        }

        if (currentCase) {
            cases.push(currentCase);
        }

        // 如果没有解析到测试用例，返回空数组
        return cases;
    }

    // 创建菜单
    async function createMenu() {
        const menuName = prompt('请输入一级菜单名称：', '新菜单');
        if (!menuName || menuName.trim() === '') return;

        try {
            showLoading('正在创建菜单...');

            // 调用 API 创建菜单
            await apiService.createMenu(menuName.trim());

            // 清除所有缓存
            clearCache();

            // 重新加载数据
            await loadFromLocalStorage();

            addLog('创建菜单', `菜单名称: ${menuName.trim()}`);
            showToast('菜单创建成功');
        } catch (error) {
            console.error('创建菜单失败:', error);
            hideLoading();
            alert('创建菜单失败: ' + error.message);
        }
    }

    // 显示右键菜单
    function showContextMenu(e, menuId) {
        e.preventDefault();
        e.stopPropagation();

        currentMenuId = menuId;

        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'block';
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
    }

    // 隐藏右键菜单
    function hideContextMenu() {
        document.getElementById('contextMenu').style.display = 'none';
        document.getElementById('projectContextMenu').style.display = 'none';
        document.getElementById('testCaseContextMenu').style.display = 'none';
    }

    // 点击页面其他地方隐藏右键菜单
    document.addEventListener('click', hideContextMenu);

    // 测试用例右键菜单相关
    let contextMenuTestCaseId = null; // 当前右键点击的测试用例ID
    let clipboardTestCase = null; // 剪贴板中的测试用例

    // 显示测试用例右键菜单
    function showTestCaseContextMenu(e, testCaseId) {
        e.preventDefault();
        e.stopPropagation();

        contextMenuTestCaseId = testCaseId;

        const contextMenu = document.getElementById('testCaseContextMenu');
        const pasteMenuItem = document.getElementById('pasteMenuItem');

        // 如果剪贴板中有测试用例，启用粘贴选项
        if (clipboardTestCase) {
            pasteMenuItem.style.opacity = '1';
            pasteMenuItem.style.pointerEvents = 'auto';
        } else {
            pasteMenuItem.style.opacity = '0.5';
            pasteMenuItem.style.pointerEvents = 'none';
        }

        contextMenu.style.display = 'block';
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
    }

    // 复制测试用例
    async function copyTestCase() {
        hideContextMenu();
        if (!contextMenuTestCaseId) return;

        try {
            // 加载完整的测试用例详情
            const testCase = await loadTestCaseDetail(contextMenuTestCaseId);
            if (testCase) {
                clipboardTestCase = testCase;
                showToast('测试用例已复制');
                addLog('复制测试用例', `用例: ${testCase.name}`);
            }
        } catch (error) {
            console.error('复制测试用例失败:', error);
            showToast('复制失败: ' + error.message);
        }
    }

    // 粘贴测试用例
    async function pasteTestCase() {
        hideContextMenu();
        if (!clipboardTestCase || !contextMenuTestCaseId) return;

        try {
            // 获取目标测试用例所在的菜单
            const targetTestCase = testCases.find(tc => tc.id === contextMenuTestCaseId);
            if (!targetTestCase) {
                showToast('找不到目标测试用例');
                return;
            }

            const targetMenuId = targetTestCase.menuId;

            showLoading('正在粘贴测试用例...');

            // 生成新的测试用例ID
            const newId = 'test_case_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // 创建测试用例副本
            const newTestCase = {
                id: newId,
                menuId: targetMenuId,
                name: clipboardTestCase.name + ' (副本)',
                project: clipboardTestCase.project || '',
                preconditions: clipboardTestCase.preconditions || [],
                steps: clipboardTestCase.steps || [],
                expectedResults: clipboardTestCase.expectedResults || [],
                androidStatus: 'pending',
                iosStatus: 'pending',
                h5Status: 'pending'
            };

            // 调用 API 创建新测试用例
            const result = await apiService.createTestCase(newTestCase);

            if (result && result.success) {
                // 清除相关缓存
                delete testCaseListCache[targetMenuId];

                // 重新加载测试用例列表
                await loadTestCaseList(targetMenuId);

                // 重新渲染菜单列表
                renderMenuList();

                addLog('粘贴测试用例', `从 ${clipboardTestCase.name} 创建副本到菜单`);
                showToast('测试用例已粘贴');
            }
        } catch (error) {
            console.error('粘贴测试用例失败:', error);
            showToast('粘贴失败: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // 从右键菜单删除测试用例
    async function deleteTestCaseFromContextMenu() {
        hideContextMenu();
        if (!contextMenuTestCaseId) return;

        const testCase = testCases.find(tc => tc.id === contextMenuTestCaseId);
        if (!testCase) {
            showToast('找不到测试用例');
            return;
        }

        if (!confirm(`确定要删除测试用例"${testCase.name}"吗？此操作不可恢复！`)) {
            return;
        }

        try {
            showLoading('正在删除测试用例...');

            await apiService.deleteTestCase(contextMenuTestCaseId);

            // 从全局数组中移除
            const index = testCases.findIndex(tc => tc.id === contextMenuTestCaseId);
            if (index >= 0) {
                testCases.splice(index, 1);
            }

            // 清除相关缓存
            delete testCaseListCache[testCase.menuId];
            delete testCaseDetailCache[contextMenuTestCaseId];

            // 如果删除的是当前显示的测试用例，清空详情区
            if (currentTestCase && currentTestCase.id === contextMenuTestCaseId) {
                currentTestCase = null;
                document.getElementById('testCaseDetail').style.display = 'none';
                document.getElementById('emptyState').style.display = 'flex';
            }

            // 重新渲染菜单列表
            renderMenuList();

            addLog('删除测试用例', `用例: ${testCase.name}`);
            showToast('测试用例已删除');
        } catch (error) {
            console.error('删除测试用例失败:', error);
            showToast('删除失败: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // 上传测试用例到菜单
    function uploadTestCasesToMenu() {
        hideContextMenu();
        if (!currentMenuId) {
            alert('请先选择一个菜单');
            return;
        }
        document.getElementById('fileInput').click();
    }

    // 重命名菜单
    async function renameMenu() {
        hideContextMenu();
        if (!currentMenuId) return;

        const menu = menus.find(m => m.id === currentMenuId);
        if (!menu) return;

        const newName = prompt('请输入新的菜单名称：', menu.name);
        if (!newName || newName.trim() === '') return;

        try {
            showLoading('正在修改菜单名称...');

            // 调用 API 更新菜单名称
            await apiService.updateMenu(currentMenuId, newName.trim());

            // 更新本地数据
            menu.name = newName.trim();

            // 更新所有缓存中相同菜单的名称
            Object.values(menuChildrenCache).forEach(children => {
                const cachedMenu = children.find(m => m.id === currentMenuId);
                if (cachedMenu) {
                    cachedMenu.name = newName.trim();
                }
            });

            // 重新渲染菜单列表
            renderMenuList();
            updateSearchMenuFilter();

            addLog('修改菜单名称', `菜单: ${menu.name} → ${newName.trim()}`);
            showToast('菜单名称已修改');
        } catch (error) {
            console.error('修改菜单名称失败:', error);
            hideLoading();
            alert('修改菜单名称失败: ' + error.message);
        }
    }

    // 删除菜单
    async function deleteMenu() {
        hideContextMenu();
        if (!currentMenuId) return;

        const menu = menus.find(m => m.id === currentMenuId);
        if (!menu) return;

        if (!confirm(`确定要删除菜单"${menu.name}"吗？\n该菜单下的所有测试用例也会被删除！`)) {
            return;
        }

        try {
            showLoading('正在删除菜单...');

            // 调用 API 删除菜单（会自动级联删除测试用例）
            await apiService.deleteMenu(currentMenuId);

            // 清除所有缓存
            clearCache();

            // 重新加载数据
            await loadFromLocalStorage();

            showToast('菜单已删除');
        } catch (error) {
            console.error('删除菜单失败:', error);
            hideLoading();
            alert('删除菜单失败: ' + error.message);
        }
    }

    // 显示项目右键菜单
    function showProjectContextMenu(e, projectName, menuId) {
        e.preventDefault();
        e.stopPropagation();

        currentProjectName = projectName;
        currentProjectMenuId = menuId;

        const contextMenu = document.getElementById('projectContextMenu');
        contextMenu.style.display = 'block';
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
    }

    // 删除项目
    function deleteProject() {
        hideContextMenu();
        if (!currentProjectName || !currentProjectMenuId) return;

        // 统计该项目下的测试用例数量
        const projectCases = testCases.filter(tc =>
            tc.menuId === currentProjectMenuId && tc.project === currentProjectName
        );

        if (!confirm(`确定要删除项目"${currentProjectName}"吗？\n该项目下的 ${projectCases.length} 条测试用例也会被删除！`)) {
            return;
        }

        // 删除该项目下的所有测试用例
        testCases = testCases.filter(tc =>
            !(tc.menuId === currentProjectMenuId && tc.project === currentProjectName)
        );

        saveToLocalStorage();
        renderMenuList();
        updateStats();

        // 隐藏详情面板（如果当前显示的是被删除项目的用例）
        if (currentTestCase && currentTestCase.project === currentProjectName) {
            document.getElementById('testCaseDetail').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
            currentTestCase = null;
        }

        addLog('删除项目', `项目名称: ${currentProjectName}, 删除用例数: ${projectCases.length}`);
        showToast('项目已删除');
    }

    // 创建示例数据
    function createSampleData() {
        return [
            {
                id: 'TC001',
                menuId: 'default',
                project: 'F03-VIP神秘人特权',
                name: '神秘人送礼明细隐私保护',
                preconditions: [
                    '用户A已开启神秘人模式',
                    '用户A向主播B赠送礼物',
                    '主播B为受礼方'
                ],
                steps: [
                    '用户A以神秘人身份在直播间赠送100金币礼物',
                    '主播B打开个人中心查看收礼明细',
                    '验证明细中是否显示用户A的真实UID',
                    '主播B查看房间收礼统计',
                    '主播B导出收礼数据报表'
                ],
                expectedResults: [
                    '主播收礼明细中，用户A的UID被隐藏',
                    '明细显示"神秘人"标识，不显示真实UID',
                    '导出报表中UID字段被加密或脱敏',
                    '后台管理员在必要权限下可查看真实UID'
                ],
                androidStatus: 'pending',
                iosStatus: 'pending'
            },
            {
                id: 'TC002',
                menuId: 'default',
                project: 'F05-音乐播放器',
                name: '音乐播放器基础功能',
                preconditions: [
                    '用户在直播间或聊天室',
                    '音乐播放器已打开',
                    '播放列表中有音乐'
                ],
                steps: [
                    '选择一首音乐并播放',
                    '点击暂停按钮',
                    '点击继续播放',
                    '拖动音量条调节音量',
                    '拖动进度条到中间位置'
                ],
                expectedResults: [
                    '音乐正常播放',
                    '暂停功能正常',
                    '继续播放功能正常',
                    '音量调节流畅，实时生效',
                    '进度条可拖动且准确'
                ],
                androidStatus: 'pending',
                iosStatus: 'pending'
            }
        ];
    }

    // 构建菜单树结构
    function buildMenuTree(menus) {
        const menuMap = {};
        const rootMenus = [];

        // 第一遍：创建所有菜单的映射
        menus.forEach(menu => {
            menuMap[menu.id] = {
                ...menu,
                children: []
            };
        });

        // 第二遍：建立父子关系
        menus.forEach(menu => {
            const menuNode = menuMap[menu.id];
            if (menu.parent_id && menuMap[menu.parent_id]) {
                // 有父菜单，添加到父菜单的 children 中
                menuMap[menu.parent_id].children.push(menuNode);
            } else {
                // 没有父菜单，是根菜单（一级菜单）
                rootMenus.push(menuNode);
            }
        });

        return rootMenus;
    }

    // 获取菜单及其所有子菜单的ID列表
    function getAllMenuIds(menuNode) {
        const ids = [menuNode.id];
        if (menuNode.children && menuNode.children.length > 0) {
            menuNode.children.forEach(child => {
                ids.push(...getAllMenuIds(child));
            });
        }
        return ids;
    }

    // 递归渲染菜单节点
    function renderMenuNode(menuNode, level = 1, isSmokeMenu = false) {
        const displayTestCases = searchKeyword && searchResults.length > 0
            ? searchResults.map(r => r.testCase)
            : testCases;

        // 获取该菜单及其所有子菜单下的测试用例
        const menuIds = getAllMenuIds(menuNode);
        const menuTestCases = displayTestCases.filter(tc => menuIds.includes(tc.menuId));

        // 在搜索模式下，如果该菜单及其所有子菜单都没有匹配的测试用例，跳过渲染
        if (searchKeyword && menuTestCases.length === 0) {
            return null;
        }

        const container = document.createElement('div');
        container.style.marginLeft = (level > 1 ? '10px' : '0px');

        // 渲染菜单项
        const menuDiv = document.createElement('div');
        menuDiv.className = 'menu-item';
        menuDiv.style.paddingLeft = '10px';
        menuDiv.dataset.menuId = menuNode.id; // 添加菜单 ID 用于状态保存

        // 如果是从仓库创建的菜单，添加特殊class
        if (menuNode.is_from_repository && level === 1) {
            menuDiv.classList.add('project-name', 'from-repository');
        }

        // 根据层级添加不同的样式
        if (level === 1) {
            menuDiv.style.fontWeight = 'bold';
            menuDiv.style.fontSize = '14px';
            // 如果不是从仓库创建的，才设置默认背景
            if (!menuNode.is_from_repository) {
                menuDiv.style.background = '#f5f7fa';
            }
        } else if (level === 2) {
            menuDiv.style.fontWeight = '600';
            menuDiv.style.fontSize = '13px';
            menuDiv.style.background = '#fafbfc';
        } else {
            menuDiv.style.fontWeight = 'normal';
            menuDiv.style.fontSize = '13px';
            menuDiv.style.background = '#fcfcfc';
        }

        // 判断菜单是否有内容（优先使用 API 返回的信息，支持懒加载）
        let hasContent;
        if (menuNode.stats) {
            // 懒加载模式：使用 API 返回的 has_children 和 stats 判断
            hasContent = menuNode.has_children || menuNode.stats.total_test_cases > 0;
        } else {
            // 兼容旧模式：使用已加载的数据判断
            hasContent = (menuNode.children && menuNode.children.length > 0) || menuTestCases.filter(tc => tc.menuId === menuNode.id).length > 0;
        }

        // 检查菜单是否应该展开（使用菜单 ID）
        const shouldExpand = getExpandedMenus().has(menuNode.id);
        const collapseIcon = hasContent ? `<span class="collapse-icon ${shouldExpand ? '' : 'collapsed'}">${shouldExpand ? '▼' : '▶'}</span> ` : '';

        // 显示逻辑：有子菜单显示子菜单数量，没有子菜单显示测试用例数量
        let displayCount;
        if (menuNode.has_children) {
            // 有子菜单：显示子菜单数量
            displayCount = menuNode.children_count || (menuNode.children && menuNode.children.length) || 0;
        } else {
            // 没有子菜单：显示测试用例数量
            displayCount = menuNode.stats ? menuNode.stats.total_test_cases : menuTestCases.length;
        }

        // 只在冒烟用例tab显示执行按钮
        const showExecuteBtn = isSmokeMenu && (level === 1 || (level > 1 && !menuNode.has_children));
        const executeBtnHtml = showExecuteBtn ? `<button class="execute-btn execute-btn-menu execute-menu" data-menu-id="${menuNode.id}" data-menu-name="${menuNode.name}" data-menu-level="${level}" title="批量执行此菜单下的所有用例">⚡ 批量执行</button>` : '';

        menuDiv.innerHTML = `
            <span>${collapseIcon}${menuNode.name}</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span>${displayCount}</span>
                ${executeBtnHtml}
            </div>
        `;

        // 执行按钮点击事件（需要在innerHTML设置之后添加）
        setTimeout(() => {
            const executeMenuBtn = menuDiv.querySelector('.execute-menu');
            if (executeMenuBtn) {
                executeMenuBtn.onclick = (e) => {
                    e.stopPropagation();
                    const menuId = executeMenuBtn.dataset.menuId;
                    const menuName = executeMenuBtn.dataset.menuName;
                    showExecutionDialog((platform) => {
                        executeMenuTestCases(menuId, menuName, platform, isSmokeMenu);
                    });
                };
            }
        }, 0);

        // 右键菜单
        menuDiv.oncontextmenu = (e) => showContextMenu(e, menuNode.id);

        // 拖拽悬停
        menuDiv.ondragover = (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            menuDiv.classList.add('drag-over');
        };

        // 拖拽离开
        menuDiv.ondragleave = (e) => {
            e.preventDefault();
            e.stopPropagation();
            menuDiv.classList.remove('drag-over');
        };

        // 拖拽放下
        menuDiv.ondrop = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            menuDiv.classList.remove('drag-over');

            const testCaseId = e.dataTransfer.getData('testCaseId');
            if (!testCaseId) return;

            const targetMenuId = menuNode.id;

            // 检查是否拖拽到原来的菜单
            const testCase = testCases.find(tc => tc.id === testCaseId);
            if (testCase && testCase.menuId === targetMenuId) {
                showToast('测试用例已在该菜单中');
                return;
            }

            try {
                showLoading('正在移动测试用例...');

                // 调用 API 移动测试用例
                const result = await apiService.moveTestCase(testCaseId, targetMenuId);

                if (result && result.success) {
                    // 更新本地数据
                    if (testCase) {
                        const oldMenuId = testCase.menuId;
                        testCase.menuId = targetMenuId;

                        // 清除相关缓存
                        delete testCaseListCache[oldMenuId];
                        delete testCaseListCache[targetMenuId];
                    }

                    // 重新渲染菜单列表
                    renderMenuList();

                    addLog('移动测试用例', `用例 ${testCaseId} 移动到菜单 ${menuNode.name}`);
                    showToast('测试用例已移动');
                }
            } catch (error) {
                console.error('移动测试用例失败:', error);
                showToast('移动失败: ' + error.message);
            } finally {
                hideLoading();
            }
        };

        // 创建内容容器
        const menuContent = document.createElement('div');
        menuContent.className = 'menu-content';
        menuContent.style.display = shouldExpand ? 'block' : 'none';

        // 渲染子菜单
        if (menuNode.children && menuNode.children.length > 0) {
            menuNode.children.forEach(childNode => {
                const childElement = renderMenuNode(childNode, level + 1, isSmokeMenu);
                if (childElement) {
                    menuContent.appendChild(childElement);
                }
            });
        }

        // 渲染该菜单直接关联的测试用例
        const directTestCases = menuTestCases.filter(tc => tc.menuId === menuNode.id);
        if (directTestCases.length > 0) {
            // 检查是否有有效的 project（非空）
            const hasProjects = directTestCases.some(tc => tc.project && tc.project.trim() !== '');

            if (hasProjects) {
                // 如果有project，按project分组显示
                const grouped = {};
                directTestCases.forEach(tc => {
                    const project = tc.project || '未分类';
                    if (!grouped[project]) {
                        grouped[project] = [];
                    }
                    grouped[project].push(tc);
                });

                for (const [project, cases] of Object.entries(grouped)) {
                    const projectItem = document.createElement('div');
                    projectItem.style.marginBottom = '10px';
                    projectItem.style.marginLeft = '15px';

                    const projectName = document.createElement('div');
                    projectName.className = 'project-name';

                    // 检查项目分组是否应该展开
                    const projectKey = `${menuNode.id}:${project}`;
                    const shouldExpandProject = getExpandedMenus().has(projectKey);

                    projectName.innerHTML = `
                        <span><span class="collapse-icon ${shouldExpandProject ? '' : 'collapsed'}">${shouldExpandProject ? '▼' : '▶'}</span> ${project}</span>
                        <span>${cases.length}</span>
                    `;
                    projectName.dataset.projectKey = projectKey;

                    const caseList = document.createElement('ul');
                    caseList.className = 'test-case-list';
                    caseList.style.display = shouldExpandProject ? 'block' : 'none';

                    cases.forEach(tc => {
                        const caseItem = document.createElement('li');
                        caseItem.className = 'test-case-item';
                        caseItem.setAttribute('data-test-case-id', tc.id); // 添加用例 ID
                        caseItem.draggable = true; // 启用拖拽

                        if (searchKeyword && searchResults.some(r => r.testCase.id === tc.id)) {
                            caseItem.classList.add('search-highlight');
                        }

                        // 只在冒烟用例时显示执行按钮
                        const executeSingleBtnHtml = isSmokeMenu ? `<button class="execute-btn execute-single" data-test-case-id="${tc.id}" data-test-case-name="${tc.name}" title="自动化执行此用例">🚀 执行</button>` : '';

                        caseItem.innerHTML = `
                            <span class="test-case-name">${tc.name.replace(/\*/g, '')}</span>
                            <div class="test-case-item-actions">
                                <div class="status-group">
                                    <span class="status-badge status-${tc.androidStatus}" data-platform="android" title="Android: ${getStatusText(tc.androidStatus)}">📱</span>
                                    <span class="status-badge status-${tc.iosStatus}" data-platform="ios" title="iOS: ${getStatusText(tc.iosStatus)}">🍎</span>
                                    <span class="status-badge status-${tc.h5Status}" data-platform="h5" title="H5: ${getStatusText(tc.h5Status)}">🌐</span>
                                </div>
                                ${executeSingleBtnHtml}
                            </div>
                        `;

                        // 点击整个用例行（标题区域）→ 默认跳转到 Android
                        caseItem.onclick = (e) => {
                            showTestCase(tc, 'android');
                        };

                        // 右键菜单
                        caseItem.oncontextmenu = (e) => {
                            showTestCaseContextMenu(e, tc.id);
                        };

                        // 拖拽开始
                        caseItem.ondragstart = (e) => {
                            e.stopPropagation();
                            e.dataTransfer.setData('testCaseId', tc.id);
                            e.dataTransfer.effectAllowed = 'move';
                            caseItem.classList.add('dragging');
                        };

                        // 拖拽结束
                        caseItem.ondragend = (e) => {
                            caseItem.classList.remove('dragging');
                            // 清除所有菜单的拖拽悬停状态
                            document.querySelectorAll('.menu-item.drag-over').forEach(item => {
                                item.classList.remove('drag-over');
                            });
                        };

                        // 点击图标 → 跳转到对应平台（阻止冒泡，避免触发整行点击）
                        caseItem.querySelectorAll('.status-badge').forEach(badge => {
                            badge.onclick = (e) => {
                                e.stopPropagation();
                                const platform = badge.getAttribute('data-platform');
                                showTestCase(tc, platform);
                            };
                        });

                        // 执行按钮点击事件
                        const executeBtn = caseItem.querySelector('.execute-single');
                        if (executeBtn) {
                            executeBtn.onclick = (e) => {
                                e.stopPropagation();
                                const testCaseId = executeBtn.dataset.testCaseId;
                                const testCaseName = executeBtn.dataset.testCaseName;
                                showExecutionDialog((platform) => {
                                    executeSingleTestCase(testCaseId, testCaseName, platform);
                                });
                            };
                        }

                        caseList.appendChild(caseItem);
                    });

                    projectName.onclick = (e) => {
                        e.stopPropagation();
                        const icon = projectName.querySelector('.collapse-icon');
                        const isExpanding = caseList.style.display === 'none';

                        if (isExpanding) {
                            icon.classList.remove('collapsed');
                            icon.textContent = '▼';
                            caseList.style.display = 'block';
                            getExpandedMenus().add(projectKey);
                        } else {
                            icon.classList.add('collapsed');
                            icon.textContent = '▶';
                            caseList.style.display = 'none';
                            getExpandedMenus().delete(projectKey);
                        }

                        if (isExpanding) {
                            setTimeout(() => {
                                projectName.scrollIntoView({behavior: 'smooth', block: 'nearest'});
                            }, 100);
                        }
                    };

                    projectItem.appendChild(projectName);
                    projectItem.appendChild(caseList);
                    menuContent.appendChild(projectItem);
                }
            } else {
                // 如果没有project，直接显示测试用例列表（不分组）
                const caseList = document.createElement('ul');
                caseList.className = 'test-case-list';
                caseList.style.marginLeft = '15px';

                directTestCases.forEach(tc => {
                    const caseItem = document.createElement('li');
                    caseItem.className = 'test-case-item';
                    caseItem.setAttribute('data-test-case-id', tc.id); // 添加用例 ID
                    caseItem.draggable = true; // 启用拖拽

                    if (searchKeyword && searchResults.some(r => r.testCase.id === tc.id)) {
                        caseItem.classList.add('search-highlight');
                    }

                    // 只在冒烟用例时显示执行按钮
                    const executeSingleBtnHtml = isSmokeMenu ? `<button class="execute-btn execute-single" data-test-case-id="${tc.id}" data-test-case-name="${tc.name}" title="自动化执行此用例">🚀 执行</button>` : '';

                    caseItem.innerHTML = `
                        <span class="test-case-name">${tc.name.replace(/\*/g, '')}</span>
                        <div class="test-case-item-actions">
                            <div class="status-group">
                                <span class="status-badge status-${tc.androidStatus}" data-platform="android" title="Android: ${getStatusText(tc.androidStatus)}">📱</span>
                                <span class="status-badge status-${tc.iosStatus}" data-platform="ios" title="iOS: ${getStatusText(tc.iosStatus)}">🍎</span>
                                <span class="status-badge status-${tc.h5Status}" data-platform="h5" title="H5: ${getStatusText(tc.h5Status)}">🌐</span>
                            </div>
                            ${executeSingleBtnHtml}
                        </div>
                    `;

                    // 点击整个用例行（标题区域）→ 默认跳转到 Android
                    caseItem.onclick = (e) => {
                        showTestCase(tc, 'android');
                    };

                    // 右键菜单
                    caseItem.oncontextmenu = (e) => {
                        showTestCaseContextMenu(e, tc.id);
                    };

                    // 拖拽开始
                    caseItem.ondragstart = (e) => {
                        e.stopPropagation();
                        e.dataTransfer.setData('testCaseId', tc.id);
                        e.dataTransfer.effectAllowed = 'move';
                        caseItem.classList.add('dragging');
                    };

                    // 拖拽结束
                    caseItem.ondragend = (e) => {
                        caseItem.classList.remove('dragging');
                        // 清除所有菜单的拖拽悬停状态
                        document.querySelectorAll('.menu-item.drag-over').forEach(item => {
                            item.classList.remove('drag-over');
                        });
                    };

                    // 点击图标 → 跳转到对应平台（阻止冒泡，避免触发整行点击）
                    caseItem.querySelectorAll('.status-badge').forEach(badge => {
                        badge.onclick = (e) => {
                            e.stopPropagation();
                            const platform = badge.getAttribute('data-platform');
                            showTestCase(tc, platform);
                        };
                    });

                    // 执行按钮点击事件
                    const executeBtn = caseItem.querySelector('.execute-single');
                    if (executeBtn) {
                        executeBtn.onclick = (e) => {
                            e.stopPropagation();
                            const testCaseId = executeBtn.dataset.testCaseId;
                            const testCaseName = executeBtn.dataset.testCaseName;
                            showExecutionDialog((platform) => {
                                executeSingleTestCase(testCaseId, testCaseName, platform);
                            });
                        };
                    }

                    caseList.appendChild(caseItem);
                });

                menuContent.appendChild(caseList);
            }
        }

        // 菜单折叠/展开（支持懒加载）
        if (hasContent) {
            menuDiv.onclick = async (e) => {
                if (e.button !== 0) return;
                const icon = menuDiv.querySelector('.collapse-icon');
                if (!icon) return;

                const isExpanding = menuContent.style.display === 'none';

                if (isExpanding) {
                    icon.classList.remove('collapsed');
                    icon.textContent = '▼';
                    menuContent.style.display = 'block';
                    getExpandedMenus().add(menuNode.id);

                    // 懒加载：如果还没加载过子内容，则加载
                    if (!getLoadedMenuIds().has(menuNode.id)) {
                        console.log(`[加载菜单] ${isSmokeMenu ? '冒烟' : '测试用例'} - 菜单ID: ${menuNode.id}, 名称: ${menuNode.name}`);
                        console.log(`[缓存状态] loadedMenuIds:`, Array.from(getLoadedMenuIds()));
                        getLoadedMenuIds().add(menuNode.id);

                        // 显示加载提示
                        const loadingDiv = document.createElement('div');
                        loadingDiv.style.padding = '10px';
                        loadingDiv.style.color = '#999';
                        loadingDiv.style.fontSize = '12px';
                        loadingDiv.textContent = '加载中...';
                        menuContent.appendChild(loadingDiv);

                        // 加载子菜单（冒烟菜单加载冒烟子菜单）
                        const children = await loadMenuChildren(menuNode.id, isSmokeMenu);
                        // 加载测试用例（冒烟菜单加载冒烟用例）
                        await loadTestCaseList(menuNode.id, isSmokeMenu);

                        // 重新渲染这个菜单节点
                        if (isSmokeMenu) {
                            renderSmokeMenuList();
                        } else {
                            renderMenuList();
                        }
                    }
                } else {
                    console.log(`[折叠菜单] ${isSmokeMenu ? '冒烟' : '测试用例'} - 菜单ID: ${menuNode.id}, 名称: ${menuNode.name}`);
                    icon.classList.add('collapsed');
                    icon.textContent = '▶';
                    menuContent.style.display = 'none';
                    getExpandedMenus().delete(menuNode.id);
                }

                if (isExpanding) {
                    setTimeout(() => {
                        menuDiv.scrollIntoView({behavior: 'smooth', block: 'nearest'});
                    }, 100);
                }
            };
        }

        container.appendChild(menuDiv);
        if (hasContent) {
            container.appendChild(menuContent);
        }

        return container;
    }

    // 渲染菜单列表（支持多级树形结构）
    function renderMenuList() {
        const projectList = document.getElementById('projectList');

        // 保存当前展开的菜单状态（使用菜单ID）
        getExpandedMenus().clear();

        // 保存展开的菜单
        const currentExpandedMenus = projectList.querySelectorAll('.menu-content[style*="display: block"]');
        currentExpandedMenus.forEach(content => {
            const menuDiv = content.previousElementSibling;
            if (menuDiv && menuDiv.dataset.menuId) {
                getExpandedMenus().add(menuDiv.dataset.menuId);
            }
        });

        // 保存展开的项目分组
        const currentExpandedProjects = projectList.querySelectorAll('.test-case-list[style*="display: block"]');
        currentExpandedProjects.forEach(caseList => {
            const projectDiv = caseList.previousElementSibling;
            if (projectDiv && projectDiv.dataset.projectKey) {
                getExpandedMenus().add(projectDiv.dataset.projectKey);
            }
        });

        projectList.innerHTML = '';

        if (menus.length === 0) {
            projectList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无菜单，请点击"创建一级菜单"</div>';
            return;
        }

        // 构建菜单树
        const menuTree = buildMenuTree(menus);

        // 渲染所有根菜单
        menuTree.forEach(rootMenu => {
            const menuElement = renderMenuNode(rootMenu, 1);
            if (menuElement) {
                projectList.appendChild(menuElement);
            }
        });
    }

    // 兼容旧函数名
    function renderProjectList() {
        renderMenuList();
    }

    // 显示测试用例详情（支持懒加载）
    async function showTestCase(testCase, platform = 'android') {
        currentTestCase = testCase;
        currentPlatform = platform; // 设置当前平台
        isEditMode = false;
        const detail = document.getElementById('testCaseDetail');
        const emptyState = document.getElementById('emptyState');

        emptyState.style.display = 'none';
        detail.style.display = 'flex';
        detail.style.flexDirection = 'column';

        // 如果测试用例没有详情数据，先加载
        if (!testCase.preconditions || testCase.preconditions.length === 0) {
            // 显示加载状态
            detail.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">加载中...</div>';

            // 判断是否为冒烟用例（通过 originalTestCaseId 字段或当前tab）
            const isSmokeTestCase = currentSidebarTab === 'smoke' || !!testCase.originalTestCaseId;

            // 加载完整详情
            const fullTestCase = await loadTestCaseDetail(testCase.id, isSmokeTestCase);
            if (fullTestCase) {
                currentTestCase = fullTestCase;
            }
        }

        renderTestCaseDetail();

        // 高亮当前选中的测试用例
        // 使用 setTimeout 确保 DOM 已经渲染完成
        setTimeout(() => {
            document.querySelectorAll('.test-case-item').forEach(item => {
                item.classList.remove('active');
            });

            // 通过 testCase.id 找到对应的用例项并高亮
            const activeItem = document.querySelector(`.test-case-item[data-test-case-id="${testCase.id}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }, 0);
    }

    // 渲染测试用例详情（查看或编辑模式）
    function renderTestCaseDetail() {
        const detail = document.getElementById('testCaseDetail');
        const testCase = isEditMode ? editingTestCase : currentTestCase;

        if (isEditMode) {
            // 编辑模式
            detail.innerHTML = `
                    <div class="test-case-header">
                        ${testCase.priority && testCase.priority !== 'P3'
                            ? `<span class="priority-badge ${testCase.priority}">${testCase.priority}</span>`
                            : ''}
                        ${testCase.id} - 编辑测试用例
                        <button class="btn-cancel" onclick="cancelEdit()" style="float: right; padding: 6px 12px; font-size: 14px;">取消</button>
                    </div>

                    <div class="test-case-content" style="overflow-y: auto; flex: 1; max-height: calc(100% - 80px);">
                        <div class="test-case-section">
                            <div class="section-title">
                                <span>📝</span>
                                <span>测试用例名称</span>
                            </div>
                            <input type="text" class="edit-input" id="editName" value="${testCase.name}" />
                        </div>

                        <div class="test-case-section">
                            <div class="section-title">
                                <span>📋</span>
                                <span>前置条件</span>
                            </div>
                            <div class="section-content">
                                <ul class="edit-list" id="editPreconditions">
                                    ${testCase.preconditions.map((p, i) => `
                                        <li class="edit-list-item">
                                            <input type="text" value="${p}" data-index="${i}" />
                                            <button class="btn-remove" onclick="removeItem('preconditions', ${i})">删除</button>
                                        </li>
                                    `).join('')}
                                </ul>
                                <button class="btn-add" onclick="addItem('preconditions')">+ 添加前置条件</button>
                            </div>
                        </div>

                        <div class="test-case-section">
                            <div class="section-title">
                                <span>📝</span>
                                <span>操作步骤</span>
                            </div>
                            <div class="section-content">
                                <ul class="edit-list" id="editSteps">
                                    ${testCase.steps.map((s, i) => `
                                        <li class="edit-list-item">
                                            <input type="text" value="${s}" data-index="${i}" />
                                            <button class="btn-remove" onclick="removeItem('steps', ${i})">删除</button>
                                        </li>
                                    `).join('')}
                                </ul>
                                <button class="btn-add" onclick="addItem('steps')">+ 添加操作步骤</button>
                            </div>
                        </div>

                        <div class="test-case-section">
                            <div class="section-title">
                                <span>✅</span>
                                <span>预期结果</span>
                            </div>
                            <div class="section-content">
                                <ul class="edit-list" id="editExpectedResults">
                                    ${testCase.expectedResults.map((r, i) => `
                                        <li class="edit-list-item">
                                            <input type="text" value="${r}" data-index="${i}" />
                                            <button class="btn-remove" onclick="removeItem('expectedResults', ${i})">删除</button>
                                        </li>
                                    `).join('')}
                                </ul>
                                <button class="btn-add" onclick="addItem('expectedResults')">+ 添加预期结果</button>
                            </div>
                        </div>

                        <div class="edit-actions">
                            <button class="btn-save" onclick="saveTestCase()">💾 保存</button>
                            <button class="btn-cancel" onclick="cancelEdit()">❌ 取消</button>
                        </div>
                    </div>
                `;
        } else {
            // 查看模式
            // 获取当前平台的不通过原因
            let failReason = '';
            if (currentPlatform === 'android' && testCase.androidFailReason) {
                failReason = testCase.androidFailReason;
            } else if (currentPlatform === 'ios' && testCase.iosFailReason) {
                failReason = testCase.iosFailReason;
            } else if (currentPlatform === 'h5' && testCase.h5FailReason) {
                failReason = testCase.h5FailReason;
            }

            const platformName = currentPlatform === 'android' ? 'Android' : (currentPlatform === 'ios' ? 'iOS' : 'H5');

            detail.innerHTML = `
                    <div class="test-case-header">
                        ${testCase.priority && testCase.priority !== 'P3'
                            ? `<span class="priority-badge ${testCase.priority}">${testCase.priority}</span>`
                            : ''}
                        ${testCase.name}
                    </div>

                    <div class="test-case-content" style="overflow-y: auto; flex: 1; max-height: calc(100% - 80px);">
                        ${failReason ? `
                        <div class="fail-reason-display">
                            <div class="fail-reason-title">
                                <span>❌</span>
                                <span>${platformName} 不通过原因</span>
                            </div>
                            <div class="fail-reason-text">${failReason}</div>
                        </div>
                        ` : ''}

                        <div class="test-case-section">
                            <div class="section-title">
                                <span>📋</span>
                                <span>前置条件</span>
                            </div>
                            <div class="section-content">
                                <ul>
                                    ${testCase.preconditions.map(p => `<li>${p}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <div class="test-case-section">
                            <div class="section-title">
                                <span>📝</span>
                                <span>操作步骤</span>
                            </div>
                            <div class="section-content">
                                <ul>
                                    ${testCase.steps.map((s, i) => `<li>步骤${i + 1}：${s}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <div class="test-case-section">
                            <div class="section-title">
                                <span>✅</span>
                                <span>预期结果</span>
                            </div>
                            <div class="section-content">
                                <ul>
                                    ${testCase.expectedResults.map(r => `<li>${r}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <!-- 按钮区域 - 放在预期结果下面 -->
                        <div class="buttons-area" style="margin-top: 30px;">
                            <!-- 状态按钮 -->
                            <div class="buttons-section">
                                <div class="section-label">测试状态</div>
                                <div class="status-buttons">
                                    <button class="status-btn btn-pass" onclick="setStatus('passed')">
                                        <span>✓</span>
                                        <span>通过</span>
                                    </button>
                                    <button class="status-btn btn-fail" onclick="setStatus('failed')">
                                        <span>✗</span>
                                        <span>不通过</span>
                                    </button>
                                    <button class="status-btn btn-skip" onclick="setStatus('skipped')">
                                        <span>〇</span>
                                        <span>跳过</span>
                                    </button>
                                </div>
                            </div>

                            <!-- 平台选择按钮 -->
                            <div class="buttons-section">
                                <div class="section-label">测试平台</div>
                                <div class="platform-buttons">
                                    <button class="platform-btn ${currentPlatform === 'android' ? 'active' : ''}" onclick="switchPlatform('android')">
                                        <span>📱</span>
                                        <span>Android</span>
                                    </button>
                                    <button class="platform-btn ${currentPlatform === 'ios' ? 'active' : ''}" onclick="switchPlatform('ios')">
                                        <span>🍎</span>
                                        <span>iOS</span>
                                    </button>
                                    <button class="platform-btn ${currentPlatform === 'h5' ? 'active' : ''}" onclick="switchPlatform('h5')">
                                        <span>🌐</span>
                                        <span>H5</span>
                                    </button>
                                </div>
                            </div>

                            <!-- 用例操作按钮 -->
                            <div class="buttons-section">
                                <div class="section-label">用例操作</div>
                                <div class="action-buttons-grid">
                                    <button class="btn-edit" onclick="enterEditMode()">
                                        <span>✏️</span>
                                        <span>编辑</span>
                                    </button>
                                    ${currentSidebarTab === 'smoke' ? `
                                    <button class="btn-execute-detail" onclick="executeDetailTestCase()">
                                        <span>🚀</span>
                                        <span>执行</span>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }
    }

    // 进入编辑模式
    function enterEditMode() {
        if (!currentTestCase) return;

        isEditMode = true;
        // 创建当前测试用例的深拷贝
        editingTestCase = JSON.parse(JSON.stringify(currentTestCase));
        renderTestCaseDetail();
    }

    // 取消编辑
    function cancelEdit() {
        isEditMode = false;
        editingTestCase = null;
        renderTestCaseDetail();
    }

    // 添加项目
    function addItem(section) {
        editingTestCase[section].push('');
        renderTestCaseDetail();
    }

    // 删除项目
    function removeItem(section, index) {
        editingTestCase[section].splice(index, 1);
        renderTestCaseDetail();
    }

    // 保存测试用例
    async function saveTestCase() {
        if (!editingTestCase) return;

        // 收集表单数据
        const name = document.getElementById('editName').value.trim();
        if (!name) {
            alert('测试用例名称不能为空');
            return;
        }

        editingTestCase.name = name;

        // 收集前置条件
        const preconditionsInputs = document.querySelectorAll('#editPreconditions input');
        editingTestCase.preconditions = Array.from(preconditionsInputs)
            .map(input => input.value.trim())
            .filter(v => v);

        // 收集操作步骤
        const stepsInputs = document.querySelectorAll('#editSteps input');
        editingTestCase.steps = Array.from(stepsInputs)
            .map(input => input.value.trim())
            .filter(v => v);

        // 收集预期结果
        const expectedResultsInputs = document.querySelectorAll('#editExpectedResults input');
        editingTestCase.expectedResults = Array.from(expectedResultsInputs)
            .map(input => input.value.trim())
            .filter(v => v);

        try {
            showLoading('正在保存...');

            // 调用 API 更新测试用例
            const updates = {
                name: editingTestCase.name,
                preconditions: editingTestCase.preconditions.join('\n'),
                steps: editingTestCase.steps.join('\n'),
                expectedResults: editingTestCase.expectedResults.join('\n')
            };

            const response = await apiService.updateTestCase(currentTestCase.id, updates);

            if (response.success || response.message) {
                // 更新本地测试用例对象
                Object.assign(currentTestCase, editingTestCase);

                // 刷新列表
                renderMenuList();

                // 退出编辑模式
                isEditMode = false;
                editingTestCase = null;
                renderTestCaseDetail();

                addLog('保存测试用例', `用例ID: ${currentTestCase.id}, 用例名称: ${currentTestCase.name}`);
                showToast('保存成功');
            }
        } catch (error) {
            console.error('保存测试用例失败:', error);
            showToast('保存失败：' + error.message);
        } finally {
            hideLoading();
        }
    }

    // 删除测试用例
    async function deleteTestCase() {
        if (!currentTestCase) return;

        if (!confirm(`确定要删除测试用例"${currentTestCase.name}"吗？`)) {
            return;
        }

        const deletedCaseName = currentTestCase.name;
        const deletedCaseId = currentTestCase.id;

        try {
            showLoading('正在删除测试用例...');

            // 调用 API 删除测试用例
            await apiService.deleteTestCase(deletedCaseId);

            // 隐藏详情面板
            document.getElementById('testCaseDetail').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';

            currentTestCase = null;
            isEditMode = false;
            editingTestCase = null;

            // 重新加载数据
            await loadFromLocalStorage();

            addLog('删除测试用例', `用例ID: ${deletedCaseId}, 用例名称: ${deletedCaseName}`);
            showToast('删除成功');
        } catch (error) {
            console.error('删除测试用例失败:', error);
            hideLoading();
            alert('删除失败: ' + error.message);
        }
    }

    // 切换平台
    function switchPlatform(platform) {
        currentPlatform = platform;

        // 重新渲染详情，以显示正确的不通过原因和平台按钮状态
        renderTestCaseDetail();

        // 显示提示
        const platformName = platform === 'android' ? 'Android' : (platform === 'ios' ? 'iOS' : 'H5');
        showToast(`已切换到 ${platformName} 平台`);
    }

    // 设置测试状态
    async function setStatus(status) {
        if (!currentTestCase) return;

        // 如果是不通过状态，显示弹窗
        if (status === 'failed') {
            pendingFailStatus = true;
            showFailReasonModal();
            return;
        }

        try {
            showLoading('正在更新状态...');

            // 调用 API 更新状态
            const response = await apiService.updateTestCaseStatus(
                currentTestCase.id,
                currentPlatform,
                status,
                ''
            );

            if (response.success) {
                // 更新本地测试用例数据（H5 互斥逻辑由后端处理）
                currentTestCase.androidStatus = response.data.androidStatus;
                currentTestCase.androidFailReason = response.data.androidFailReason;
                currentTestCase.iosStatus = response.data.iosStatus;
                currentTestCase.iosFailReason = response.data.iosFailReason;
                currentTestCase.h5Status = response.data.h5Status;
                currentTestCase.h5FailReason = response.data.h5FailReason;

                // 刷新显示
                renderProjectList();
                updateStats();
                renderTestCaseDetail();

                // 显示提示
                const statusText = getStatusText(status);
                const platformName = currentPlatform === 'android' ? 'Android' : (currentPlatform === 'ios' ? 'iOS' : 'H5');
                addLog('更新测试状态', `用例: ${currentTestCase.id} - ${currentTestCase.name}, 平台: ${platformName}, 状态: ${statusText}`);
                showToast(`${platformName} 已标记为：${statusText}`);
            }
        } catch (error) {
            console.error('更新状态失败:', error);
            showToast('更新失败：' + error.message);
        } finally {
            hideLoading();
        }
    }

    // 获取状态文本
    function getStatusText(status) {
        const map = {
            'pending': '待测',
            'passed': '通过',
            'failed': '不通过',
            'skipped': '跳过'
        };
        return map[status] || '待测';
    }

    // 更新统计信息
    async function updateStats() {
        try {
            // 从 API 获取统计数据（包含 H5 互斥逻辑）
            const response = await apiService.getStats();

            if (response.success) {
                const stats = response.data;

                // 更新两个TAB中的统计数据
                const updateElements = (suffix = '') => {
                    const totalEl = document.getElementById('totalCount' + suffix);
                    if (totalEl) totalEl.textContent = stats.total;

                    const androidPassEl = document.getElementById('androidPassCount' + suffix);
                    if (androidPassEl) androidPassEl.textContent = stats.android.passed;
                    const androidFailEl = document.getElementById('androidFailCount' + suffix);
                    if (androidFailEl) androidFailEl.textContent = stats.android.failed;
                    const androidSkipEl = document.getElementById('androidSkipCount' + suffix);
                    if (androidSkipEl) androidSkipEl.textContent = stats.android.skipped;
                    const androidPendingEl = document.getElementById('androidPendingCount' + suffix);
                    if (androidPendingEl) androidPendingEl.textContent = stats.android.pending;

                    const iosPassEl = document.getElementById('iosPassCount' + suffix);
                    if (iosPassEl) iosPassEl.textContent = stats.ios.passed;
                    const iosFailEl = document.getElementById('iosFailCount' + suffix);
                    if (iosFailEl) iosFailEl.textContent = stats.ios.failed;
                    const iosSkipEl = document.getElementById('iosSkipCount' + suffix);
                    if (iosSkipEl) iosSkipEl.textContent = stats.ios.skipped;
                    const iosPendingEl = document.getElementById('iosPendingCount' + suffix);
                    if (iosPendingEl) iosPendingEl.textContent = stats.ios.pending;

                    const h5PassEl = document.getElementById('h5PassCount' + suffix);
                    if (h5PassEl) h5PassEl.textContent = stats.h5.passed;
                    const h5FailEl = document.getElementById('h5FailCount' + suffix);
                    if (h5FailEl) h5FailEl.textContent = stats.h5.failed;
                    const h5SkipEl = document.getElementById('h5SkipCount' + suffix);
                    if (h5SkipEl) h5SkipEl.textContent = stats.h5.skipped;
                    const h5PendingEl = document.getElementById('h5PendingCount' + suffix);
                    if (h5PendingEl) h5PendingEl.textContent = stats.h5.pending;
                };

                // 更新首页TAB（无后缀）
                updateElements('');
                // 更新数据管理TAB（带2后缀）
                updateElements('2');
            }
        } catch (error) {
            console.error('获取统计数据失败:', error);
            // 失败时显示 0
            const updateZeros = (suffix = '') => {
                const totalEl = document.getElementById('totalCount' + suffix);
                if (totalEl) totalEl.textContent = '0';
                ['android', 'ios', 'h5'].forEach(platform => {
                    const passEl = document.getElementById(`${platform}PassCount` + suffix);
                    if (passEl) passEl.textContent = '0';
                    const failEl = document.getElementById(`${platform}FailCount` + suffix);
                    if (failEl) failEl.textContent = '0';
                    const skipEl = document.getElementById(`${platform}SkipCount` + suffix);
                    if (skipEl) skipEl.textContent = '0';
                    const pendingEl = document.getElementById(`${platform}PendingCount` + suffix);
                    if (pendingEl) pendingEl.textContent = '0';
                });
            };
            updateZeros('');
            updateZeros('2');
        }
    }

    /* 进度统计相关功能已删除
    // 渲染圆盘进度图
    function renderProgressCircles(selectedMenuId = null) {
        const container = document.getElementById('progressCircleContent');
        container.innerHTML = '';

        if (menus.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暂无菜单数据</div>';
            return;
        }

        // 根据选择过滤菜单
        let menusToShow = menus;
        if (selectedMenuId && selectedMenuId !== 'all') {
            menusToShow = menus.filter(m => m.id === selectedMenuId);
        }

        menusToShow.forEach(menu => {
            // 获取该菜单下的测试用例
            const menuTestCases = testCases.filter(tc => tc.menuId === menu.id);
            const total = menuTestCases.length;

            if (total === 0) return;

            // 创建菜单项
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-progress-item';

            const title = document.createElement('div');
            title.className = 'menu-progress-title';
            title.textContent = menu.name;

            // 创建三个圆盘的容器
            const circlesRow = document.createElement('div');
            circlesRow.className = 'progress-circles-row';

            // 为每个平台创建圆盘
            const platforms = [
                { name: 'Android', emoji: '📱', statusKey: 'androidStatus' },
                { name: 'iOS', emoji: '🍎', statusKey: 'iosStatus' },
                { name: 'H5', emoji: '🌐', statusKey: 'h5Status' }
            ];

            platforms.forEach(platform => {
                // 统计该平台的状态
                let passed = 0;
                let failed = 0;
                let skipped = 0;
                let pending = 0;
                let actualTotal = 0; // 实际参与统计的用例总数

                menuTestCases.forEach(tc => {
                    // 互斥统计逻辑
                    if (platform.statusKey === 'h5Status') {
                        // H5平台：只统计Android和iOS都是pending的用例
                        const androidIsPending = tc.androidStatus === 'pending';
                        const iosIsPending = tc.iosStatus === 'pending';

                        if (androidIsPending && iosIsPending) {
                            // 只有当Android和iOS都是待测时，才计入H5统计
                            const status = tc[platform.statusKey];
                            if (status === 'passed') passed++;
                            else if (status === 'failed') failed++;
                            else if (status === 'skipped') skipped++;
                            else pending++;
                            actualTotal++;
                        }
                    } else {
                        // Android或iOS平台：只统计H5是pending的用例
                        const h5IsPending = tc.h5Status === 'pending';

                        if (h5IsPending) {
                            // 只有当H5是待测时，才计入Android/iOS统计
                            const status = tc[platform.statusKey];
                            if (status === 'passed') passed++;
                            else if (status === 'failed') failed++;
                            else if (status === 'skipped') skipped++;
                            else pending++;
                            actualTotal++;
                        }
                    }
                });

                // 创建平台圆盘容器
                const wrapper = document.createElement('div');
                wrapper.className = 'progress-circle-wrapper';

                // 平台标签
                const platformLabel = document.createElement('div');
                platformLabel.className = 'platform-label';
                platformLabel.textContent = `${platform.emoji} ${platform.name}`;

                // 创建canvas容器
                const canvasWrapper = document.createElement('div');
                canvasWrapper.style.position = 'relative';
                canvasWrapper.style.display = 'inline-block';

                // 创建canvas
                const canvas = document.createElement('canvas');
                canvas.className = 'progress-circle-canvas';
                canvas.width = 120;
                canvas.height = 120;
                canvas.dataset.menuId = menu.id;
                canvas.dataset.platform = platform.name;

                // 创建中心文本
                const centerText = document.createElement('div');
                centerText.className = 'progress-circle-center-text';
                centerText.innerHTML = `
                    <div class="progress-circle-total" style="font-size: 20px;">${actualTotal}</div>
                    <div class="progress-circle-label">总计</div>
                `;

                canvasWrapper.appendChild(canvas);
                canvasWrapper.appendChild(centerText);
                wrapper.appendChild(platformLabel);
                wrapper.appendChild(canvasWrapper);
                circlesRow.appendChild(wrapper);

                // 绘制圆盘
                drawProgressCircle(canvas, { passed, failed, skipped, pending, total: actualTotal });
            });

            menuItem.appendChild(title);
            menuItem.appendChild(circlesRow);
            container.appendChild(menuItem);
        });
    }

    // 更新菜单选择器
    function updateMenuSelector() {
        const selector = document.getElementById('menuSelector');
        if (!selector) return;

        const currentValue = selector.value;

        // 清空选项
        selector.innerHTML = '<option value="all">显示所有菜单</option>';

        // 添加所有菜单选项
        menus.forEach(menu => {
            const option = document.createElement('option');
            option.value = menu.id;
            option.textContent = menu.name;
            selector.appendChild(option);
        });

        // 如果当前值是"all"或者空（初始状态），默认选择第一个菜单（最新创建的）
        if (currentValue === 'all' || !currentValue) {
            if (menus.length > 0) {
                const latestMenu = menus[0]; // 改为选择第一个（因为新菜单在最前面）
                selector.value = latestMenu.id;
                // 立即渲染该菜单的进度
                renderProgressCircles(latestMenu.id);
            } else {
                selector.value = 'all';
            }
        } else {
            // 恢复之前的选择（如果仍然存在）
            const optionExists = Array.from(selector.options).some(opt => opt.value === currentValue);
            if (optionExists) {
                selector.value = currentValue;
            } else {
                // 之前选择的菜单不存在了，选择第一个
                if (menus.length > 0) {
                    const latestMenu = menus[0]; // 改为选择第一个
                    selector.value = latestMenu.id;
                    // 立即渲染该菜单的进度
                    renderProgressCircles(latestMenu.id);
                } else {
                    selector.value = 'all';
                }
            }
        }
    }

    // 菜单选择器变化处理
    function onMenuSelectorChange() {
        const selector = document.getElementById('menuSelector');
        const selectedMenuId = selector.value;
        renderProgressCircles(selectedMenuId === 'all' ? null : selectedMenuId);
    }

        // 绘制单个圆盘进度图
    function drawProgressCircle(canvas, data) {
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 45;
        const lineWidth = 16;

        // 清空画布
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const { passed, failed, skipped, pending, total } = data;

        // 如果没有数据，绘制灰色圆
        if (total === 0) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = lineWidth;
            ctx.stroke();
            return;
        }

        // 计算角度
        const angles = [];
        let startAngle = -Math.PI / 2; // 从顶部开始

        // 顺序：通过、不通过、跳过、待测
        const segments = [
            { count: passed, color: '#10b981', label: '通过' },
            { count: failed, color: '#ef4444', label: '不通过' },
            { count: skipped, color: '#f59e0b', label: '跳过' },
            { count: pending, color: '#d1d5db', label: '待测' }
        ];

        segments.forEach(segment => {
            if (segment.count > 0) {
                const angle = (segment.count / total) * Math.PI * 2;
                angles.push({
                    startAngle,
                    endAngle: startAngle + angle,
                    color: segment.color,
                    label: segment.label,
                    count: segment.count
                });
                startAngle += angle;
            }
        });

        // 绘制各个扇形
        angles.forEach(arc => {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, arc.startAngle, arc.endAngle);
            ctx.strokeStyle = arc.color;
            ctx.lineWidth = lineWidth;
            ctx.stroke();
        });

        // 保存角度信息到canvas，用于悬停检测
        canvas.progressData = { angles, centerX, centerY, radius, data };

        // 添加鼠标事件
        canvas.onmousemove = handleCanvasMouseMove;
        canvas.onmouseleave = handleCanvasMouseLeave;
    }

    // 处理canvas鼠标移动
    function handleCanvasMouseMove(e) {
        const canvas = e.target;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const { angles, centerX, centerY, radius } = canvas.progressData;

        // 计算鼠标相对于圆心的角度和距离
        const dx = x - centerX;
        const dy = y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx);

        // 检查是否在圆环内
        const innerRadius = radius - 16;
        const outerRadius = radius + 16;

        if (distance >= innerRadius && distance <= outerRadius) {
            // 查找鼠标所在的扇形
            for (const arc of angles) {
                let normalizedAngle = angle;
                // 将角度转换为与startAngle相同的参考系（从-90度开始）
                if (normalizedAngle < -Math.PI / 2) {
                    normalizedAngle += Math.PI * 2;
                }

                let start = arc.startAngle;
                let end = arc.endAngle;

                // 处理跨越360度的情况
                if (start > end) {
                    if (normalizedAngle >= start || normalizedAngle <= end) {
                        showProgressTooltip(e, arc);
                        return;
                    }
                } else {
                    if (normalizedAngle >= start && normalizedAngle <= end) {
                        showProgressTooltip(e, arc);
                        return;
                    }
                }
            }
        }

        hideProgressTooltip();
    }

    // 处理canvas鼠标离开
    function handleCanvasMouseLeave() {
        hideProgressTooltip();
    }

    // 显示进度提示框
    function showProgressTooltip(e, arc) {
        const tooltip = document.getElementById('progressTooltip');
        tooltip.innerHTML = `
            <div class="progress-tooltip-row">
                <div class="progress-tooltip-color" style="background: ${arc.color}"></div>
                <span>${arc.label}: ${arc.count}</span>
            </div>
        `;
        tooltip.classList.add('show');
        tooltip.style.left = (e.pageX + 10) + 'px';
        tooltip.style.top = (e.pageY + 10) + 'px';
    }

    // 隐藏进度提示框
    function hideProgressTooltip() {
        const tooltip = document.getElementById('progressTooltip');
        tooltip.classList.remove('show');
    }
    */

    // 添加日志
    function addLog(action, details) {
        const timestamp = new Date().toISOString();
        const log = {
            timestamp: timestamp,
            action: action,
            details: details,
            date: new Date(timestamp).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            })
        };
        logs.push(log);

        // 限制日志数量，最多保留1000条
        if (logs.length > 1000) {
            logs = logs.slice(-1000);
        }

        saveToLocalStorage();
        console.log('📝 日志已记录:', log);
    }

    // 下载日志
    function downloadLogs() {
        if (logs.length === 0) {
            showToast('暂无日志记录');
            return;
        }

        // 生成Markdown格式的日志
        let markdown = '# Test 测试用例管理系统 - 操作日志\n\n';
        markdown += `> 📅 导出时间：${new Date().toLocaleString('zh-CN')}\n\n`;
        markdown += `> 📊 总日志数：${logs.length} 条\n\n`;
        markdown += `> 💾 当前数据：菜单 ${menus.length} 个，测试用例 ${testCases.length} 条\n\n`;
        markdown += '---\n\n';

        // 按日期分组
        const logsByDate = {};
        logs.forEach(log => {
            const date = log.date.split(' ')[0]; // 获取日期部分
            if (!logsByDate[date]) {
                logsByDate[date] = [];
            }
            logsByDate[date].push(log);
        });

        // 按日期倒序输出
        const dates = Object.keys(logsByDate).sort().reverse();
        dates.forEach(date => {
            markdown += `## 📅 ${date}\n\n`;

            const dateLogs = logsByDate[date].reverse(); // 最新的在前
            dateLogs.forEach((log, index) => {
                const time = log.date.split(' ')[1]; // 获取时间部分

                // 根据操作类型添加不同的图标
                let icon = '📝';
                if (log.action.includes('上传') || log.action.includes('导入')) icon = '📤';
                else if (log.action.includes('下载') || log.action.includes('导出')) icon = '📥';
                else if (log.action.includes('删除') || log.action.includes('清除')) icon = '🗑️';
                else if (log.action.includes('创建')) icon = '➕';
                else if (log.action.includes('保存') || log.action.includes('更新')) icon = '💾';
                else if (log.action.includes('搜索')) icon = '🔍';
                else if (log.action.includes('Excel解析')) icon = '📊';
                else if (log.action.includes('标记')) icon = '✅';

                markdown += `### ${icon} ${index + 1}. ${log.action}\n\n`;
                markdown += `- ⏰ **时间**: ${time}\n`;
                markdown += `- 📋 **详情**: ${log.details}\n`;
                markdown += '\n';
            });

            markdown += '---\n\n';
        });

        // 创建Blob并下载
        const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Test操作日志_${new Date().toISOString().split('T')[0]}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        addLog('下载操作日志', `下载日志文件, 共 ${logs.length} 条记录, 文件名: Test操作日志_${new Date().toISOString().split('T')[0]}.md`);
        showToast('日志已下载');
    }


    // 导出测试结果
    function exportResults() {
        if (testCases.length === 0) {
            alert('没有测试数据可导出');
            return;
        }

        const results = {
            exportTime: new Date().toLocaleString('zh-CN'),
            summary: {
                total: testCases.length,
                menuCount: menus.length,
                android: {
                    passed: testCases.filter(tc => tc.androidStatus === 'passed').length,
                    failed: testCases.filter(tc => tc.androidStatus === 'failed').length,
                    skipped: testCases.filter(tc => tc.androidStatus === 'skipped').length,
                    pending: testCases.filter(tc => tc.androidStatus === 'pending').length
                },
                ios: {
                    passed: testCases.filter(tc => tc.iosStatus === 'passed').length,
                    failed: testCases.filter(tc => tc.iosStatus === 'failed').length,
                    skipped: testCases.filter(tc => tc.iosStatus === 'skipped').length,
                    pending: testCases.filter(tc => tc.iosStatus === 'pending').length
                },
                h5: {
                    passed: testCases.filter(tc => tc.h5Status === 'passed').length,
                    failed: testCases.filter(tc => tc.h5Status === 'failed').length,
                    skipped: testCases.filter(tc => tc.h5Status === 'skipped').length,
                    pending: testCases.filter(tc => tc.h5Status === 'pending').length
                }
            },
            menus: menus,
            testCases: testCases
        };

        const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const fileName = `测试结果_${new Date().getTime()}.json`;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);

        addLog('导出测试结果', `文件名: ${fileName}, 菜单数: ${results.summary.menuCount}, 用例数: ${results.summary.total}, Android通过: ${results.summary.android.passed}, iOS通过: ${results.summary.ios.passed}, H5通过: ${results.summary.h5.passed}`);
        showToast('测试结果已导出');
    }

    // 显示提示信息
    function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: #333;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    // ==================== 自动化执行相关函数 ====================

    // 全局变量：当前执行轮询定时器
    let currentExecutionPollInterval = null;
    let currentExecutionName = '';

    // 取消当前执行
    function cancelCurrentExecution() {
        if (currentExecutionPollInterval) {
            clearInterval(currentExecutionPollInterval);
            currentExecutionPollInterval = null;
        }
        hideLoading();
        showToast(`❌ 已取消执行: ${currentExecutionName}`);
        currentExecutionName = '';
    }

    // 执行单条测试用例
    async function executeSingleTestCase(testCaseId, testCaseName, platform) {
        try {
            console.log(`[执行测试用例] ID: ${testCaseId}, 平台: ${platform}`);
            showLoading(`正在提交测试用例: ${testCaseName}...`);

            const result = await apiService.executeTestCase(testCaseId, platform);

            if (result && result.success) {
                const executionId = result.data.taskId || result.data.executionId;
                hideLoading();

                // 使用新的进度弹窗
                const progressModal = new ExecutionProgressModal(
                    executionId,
                    testCaseName,
                    platform,
                    'simple'
                );
                progressModal.show();
            } else {
                hideLoading();
                showToast('执行失败: ' + (result.error || '未知错误'));
            }
        } catch (error) {
            console.error('执行测试用例失败:', error);
            hideLoading();
            showToast('执行失败: ' + error.message);
        }
    }

    // 执行菜单下的所有测试用例
    async function executeMenuTestCases(menuId, menuName, platform, isSmokeMenu = false) {
        try {
            console.log(`[批量执行] 菜单: ${menuName}, 平台: ${platform}`);

            // 获取菜单下的所有测试用例
            showLoading('正在获取测试用例列表...');
            const cacheKey = isSmokeMenu ? `smoke_${menuId}` : menuId;
            let testCasesList = testCaseListCache[cacheKey];

            if (!testCasesList) {
                // 如果缓存中没有，从API加载
                testCasesList = await loadTestCaseList(menuId, isSmokeMenu);
            }

            if (!testCasesList || testCasesList.length === 0) {
                hideLoading();
                showToast('该菜单下没有测试用例');
                return;
            }

            const testCaseIds = testCasesList.map(tc => tc.id);
            console.log(`[批量执行] 共 ${testCaseIds.length} 条用例`);

            showLoading(`正在批量执行 ${testCaseIds.length} 条测试用例...`);

            const result = await apiService.executeBatchTestCases(testCaseIds, platform);

            if (result && result.success) {
                hideLoading();
                showToast(`已提交 ${testCaseIds.length} 条测试用例执行`);

                // 可以选择轮询批量执行状态
                if (result.data && result.data.taskIds) {
                    result.data.taskIds.forEach((taskId, index) => {
                        setTimeout(() => {
                            pollExecutionStatus(taskId, `${menuName} - 用例${index + 1}`);
                        }, index * 1000); // 错开轮询时间
                    });
                }
            } else {
                hideLoading();
                showToast('批量执行失败: ' + (result.error || '未知错误'));
            }
        } catch (error) {
            console.error('批量执行失败:', error);
            hideLoading();
            showToast('批量执行失败: ' + error.message);
        }
    }

    // 轮询执行状态
    function pollExecutionStatus(executionId, testCaseName) {
        const maxAttempts = 60; // 最多轮询60次（5分钟）
        let attempts = 0;

        // 保存当前执行信息
        currentExecutionName = testCaseName;

        // 清除之前的轮询（如果有）
        if (currentExecutionPollInterval) {
            clearInterval(currentExecutionPollInterval);
        }

        currentExecutionPollInterval = setInterval(async () => {
            attempts++;

            if (attempts > maxAttempts) {
                clearInterval(currentExecutionPollInterval);
                currentExecutionPollInterval = null;
                hideLoading();
                showToast(`⏱️ 执行超时: ${testCaseName}`);
                currentExecutionName = '';
                return;
            }

            try {
                const result = await apiService.getExecutionStatus(executionId);

                if (result && result.success) {
                    const status = result.data.status;
                    console.log(`[执行状态] ${testCaseName}: ${status}`);

                    if (status === 'passed') {
                        clearInterval(currentExecutionPollInterval);
                        currentExecutionPollInterval = null;
                        hideLoading();
                        showToast(`✅ 测试通过: ${testCaseName}`);
                        currentExecutionName = '';
                        // 刷新测试用例列表
                        if (currentSidebarTab === 'smoke') {
                            loadSmokeMenus();
                        } else {
                            loadMenus();
                        }
                    } else if (status === 'failed' || status === 'error') {
                        clearInterval(currentExecutionPollInterval);
                        currentExecutionPollInterval = null;
                        hideLoading();
                        showToast(`❌ 测试失败: ${testCaseName}`);
                        currentExecutionName = '';
                        // 刷新测试用例列表
                        if (currentSidebarTab === 'smoke') {
                            loadSmokeMenus();
                        } else {
                            loadMenus();
                        }
                    } else if (status === 'running') {
                        // 继续轮询 - 正在执行
                        showLoading(`正在执行: ${testCaseName}\n已用时: ${attempts * 5}秒`, true);
                    } else if (status === 'pending') {
                        // 等待执行服务拉取任务
                        showLoading(`等待执行: ${testCaseName} (${attempts * 5}秒)\n💡 提示: 需要启动执行服务`, true);
                    }
                }
            } catch (error) {
                console.error('查询执行状态失败:', error);
            }
        }, 5000); // 每5秒查询一次
    }

    // 从详情页执行测试用例
    function executeDetailTestCase() {
        if (!currentTestCase) {
            showToast('请先选择一个测试用例');
            return;
        }

        const testCaseId = currentTestCase.id;
        const testCaseName = currentTestCase.name;

        showExecutionDialog((platform) => {
            executeSingleTestCase(testCaseId, testCaseName, platform);
        });
    }

    // 显示平台选择对话框
    function showExecutionDialog(callback) {
        const dialog = document.createElement('div');
        dialog.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        `;

        dialog.innerHTML = `
            <div style="
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                padding: 40px;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                min-width: 360px;
                animation: slideUp 0.3s ease;
            ">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="
                        display: inline-block;
                        width: 60px;
                        height: 60px;
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 32px;
                        margin-bottom: 16px;
                        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
                    ">🚀</div>
                    <h3 style="margin: 0; color: #1e293b; font-size: 24px; font-weight: 700;">选择执行平台</h3>
                    <p style="margin: 8px 0 0 0; color: #64748b; font-size: 14px;">请选择要执行自动化测试的平台</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="platform-btn" data-platform="android" style="
                        padding: 16px 24px;
                        border: 2px solid transparent;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border-radius: 12px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: 600;
                        transition: all 0.3s;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 12px;
                    ">
                        <span style="font-size: 24px;">📱</span>
                        <span>Android 平台</span>
                    </button>
                    <button class="platform-btn" data-platform="ios" style="
                        padding: 16px 24px;
                        border: 2px solid transparent;
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        border-radius: 12px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: 600;
                        transition: all 0.3s;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 12px;
                    ">
                        <span style="font-size: 24px;">🍎</span>
                        <span>iOS 平台</span>
                    </button>
                    <button class="platform-btn" data-platform="h5" style="
                        padding: 16px 24px;
                        border: 2px solid transparent;
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: white;
                        border-radius: 12px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: 600;
                        transition: all 0.3s;
                        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 12px;
                    ">
                        <span style="font-size: 24px;">🌐</span>
                        <span>H5 平台</span>
                    </button>
                    <button id="cancelExecute" style="
                        padding: 14px 24px;
                        border: 2px solid #e2e8f0;
                        background: white;
                        color: #64748b;
                        border-radius: 12px;
                        cursor: pointer;
                        font-size: 15px;
                        font-weight: 600;
                        margin-top: 12px;
                        transition: all 0.3s;
                    ">取消</button>
                </div>
            </div>
        `;

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);

        document.body.appendChild(dialog);

        // 平台按钮点击事件
        dialog.querySelectorAll('.platform-btn').forEach(btn => {
            btn.onmouseover = () => {
                btn.style.transform = 'translateY(-3px) scale(1.02)';
                btn.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.15)';
            };
            btn.onmouseout = () => {
                btn.style.transform = 'translateY(0) scale(1)';
                const platform = btn.dataset.platform;
                if (platform === 'android') {
                    btn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.2)';
                } else if (platform === 'ios') {
                    btn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.2)';
                } else {
                    btn.style.boxShadow = '0 4px 12px rgba(245, 158, 11, 0.2)';
                }
            };
            btn.onclick = () => {
                const platform = btn.dataset.platform;
                dialog.style.animation = 'fadeOut 0.2s ease';
                setTimeout(() => {
                    dialog.remove();
                    callback(platform);
                }, 200);
            };
        });

        // 取消按钮
        const cancelBtn = dialog.querySelector('#cancelExecute');
        cancelBtn.onmouseover = () => {
            cancelBtn.style.background = '#f1f5f9';
            cancelBtn.style.borderColor = '#cbd5e1';
        };
        cancelBtn.onmouseout = () => {
            cancelBtn.style.background = 'white';
            cancelBtn.style.borderColor = '#e2e8f0';
        };
        cancelBtn.onclick = () => {
            dialog.style.animation = 'fadeOut 0.2s ease';
            setTimeout(() => dialog.remove(), 200);
        };

        // 点击背景关闭
        dialog.onclick = (e) => {
            if (e.target === dialog) {
                dialog.style.animation = 'fadeOut 0.2s ease';
                setTimeout(() => dialog.remove(), 200);
            }
        };

        // 添加fadeOut动画
        style.textContent += `
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
    }

    // 添加CSS动画
    const style = document.createElement('style');
    style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
    document.head.appendChild(style);

    // 更新搜索菜单过滤器
    function updateSearchMenuFilter() {
        const filterSelect = document.getElementById('searchMenuFilter');
        if (!filterSelect) return;

        // 保存当前选中的值
        const currentValue = filterSelect.value;

        // 清空选项
        filterSelect.innerHTML = '<option value="">所有菜单</option>';

        // 只添加一级菜单（level === 1）
        const level1Menus = menus.filter(m => m.level === 1);
        level1Menus.forEach(menu => {
            const option = document.createElement('option');
            option.value = menu.id;
            option.textContent = menu.name;
            filterSelect.appendChild(option);
        });

        // 恢复之前选中的值（如果还存在）
        if (currentValue) {
            const optionExists = Array.from(filterSelect.options).some(opt => opt.value === currentValue);
            if (optionExists) {
                filterSelect.value = currentValue;
            }
        }
    }

    // 执行搜索
    async function performSearch() {
        const input = document.getElementById('searchInput');
        const keyword = input.value.trim();

        if (!keyword) {
            alert('请输入搜索关键词');
            return;
        }

        try {
            showLoading('正在搜索...');

            // 获取选中的菜单 ID
            const filterSelect = document.getElementById('searchMenuFilter');
            const selectedMenuId = filterSelect ? filterSelect.value : '';

            // 调用 API 搜索失败的测试用例，传递菜单 ID
            const result = await apiService.searchFailedTestCases(keyword, selectedMenuId || null);

            searchKeyword = keyword.toLowerCase();
            searchResults = [];

            // 转换 API 返回的结果
            if (result.data && result.data.length > 0) {
                result.data.forEach(tc => {
                    const matchedPlatforms = [];

                    // 检查哪些平台的失败原因包含关键词
                    if (tc.android_fail_reason && tc.android_fail_reason.toLowerCase().includes(searchKeyword)) {
                        matchedPlatforms.push('Android');
                    }
                    if (tc.ios_fail_reason && tc.ios_fail_reason.toLowerCase().includes(searchKeyword)) {
                        matchedPlatforms.push('iOS');
                    }
                    if (tc.h5_fail_reason && tc.h5_fail_reason.toLowerCase().includes(searchKeyword)) {
                        matchedPlatforms.push('H5');
                    }

                    // 转换字段名
                    const testCase = {
                        id: tc.id,
                        menuId: tc.menu_id,
                        project: tc.project,
                        name: tc.name,
                        preconditions: parseToArray(tc.preconditions),
                        steps: parseToArray(tc.steps),
                        expectedResults: parseToArray(tc.expected_results),
                        androidStatus: tc.android_status,
                        androidFailReason: tc.android_fail_reason || '',
                        iosStatus: tc.ios_status,
                        iosFailReason: tc.ios_fail_reason || '',
                        h5Status: tc.h5_status,
                        h5FailReason: tc.h5_fail_reason || ''
                    };

                    searchResults.push({
                        testCase,
                        platforms: matchedPlatforms
                    });
                });
            }

            hideLoading();

            // 显示搜索结果提示
            const hint = document.getElementById('searchResultHint');
            if (searchResults.length > 0) {
                hint.textContent = `找到 ${searchResults.length} 条结果`;
                hint.style.display = 'inline-block';
                const resultDetails = searchResults.map(r => `${r.testCase.id}-${r.testCase.name}(${r.platforms.join(',')})`).join('; ');
                addLog('搜索不通过原因', `关键词: "${keyword}", 找到 ${searchResults.length} 条结果: ${resultDetails}`);
                showToast(`找到 ${searchResults.length} 条匹配的测试用例`);
            } else {
                hint.textContent = '未找到结果';
                hint.style.display = 'inline-block';
                addLog('搜索不通过原因', `关键词: "${keyword}", 未找到结果`);
                showToast('未找到匹配的测试用例');
            }

            // 重新渲染列表，只显示搜索结果
            renderMenuList();
        } catch (error) {
            console.error('搜索失败:', error);
            hideLoading();
            alert('搜索失败: ' + error.message);
        }
    }

    // 清除搜索
    function clearSearch() {
        searchKeyword = '';
        searchResults = [];

        const input = document.getElementById('searchInput');
        const hint = document.getElementById('searchResultHint');

        input.value = '';
        hint.style.display = 'none';

        // 重置菜单过滤器
        const filterSelect = document.getElementById('searchMenuFilter');
        if (filterSelect) {
            filterSelect.value = ''; // 重置为"所有菜单"
        }

        // 重新渲染列表，显示所有用例
        renderMenuList();
        showToast('已清除搜索');
    }

    // 处理搜索框按键事件
    function handleSearchKeyup(event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    }

    // 显示不通过原因弹窗
    function showFailReasonModal() {
        const modal = document.getElementById('failReasonModal');
        const input = document.getElementById('failReasonInput');

        // 获取当前平台的不通过原因（如果已存在）
        let existingReason = '';
        if (currentPlatform === 'android' && currentTestCase.androidFailReason) {
            existingReason = currentTestCase.androidFailReason;
        } else if (currentPlatform === 'ios' && currentTestCase.iosFailReason) {
            existingReason = currentTestCase.iosFailReason;
        } else if (currentPlatform === 'h5' && currentTestCase.h5FailReason) {
            existingReason = currentTestCase.h5FailReason;
        }

        input.value = existingReason;
        modal.classList.add('show');
        input.focus();
    }

    // 关闭不通过原因弹窗
    function closeFailReasonModal() {
        const modal = document.getElementById('failReasonModal');
        const input = document.getElementById('failReasonInput');
        modal.classList.remove('show');
        input.value = '';
        pendingFailStatus = false;
    }

    // 确认不通过原因
    async function confirmFailReason() {
        const input = document.getElementById('failReasonInput');
        const reason = input.value.trim();

        // 不通过原因改为非必填，允许空原因
        // if (!reason) {
        //     alert('请填写不通过原因');
        //     return;
        // }

        // 立即关闭弹窗
        closeFailReasonModal();

        // 显示加载状态
        showLoading('正在更新状态...');

        try {
            // 调用 API 更新状态为 failed
            const response = await apiService.updateTestCaseStatus(
                currentTestCase.id,
                currentPlatform,
                'failed',
                reason
            );

            if (response && response.success) {
                // 更新本地测试用例数据（H5 互斥逻辑由后端处理）
                currentTestCase.androidStatus = response.data.androidStatus;
                currentTestCase.androidFailReason = response.data.androidFailReason;
                currentTestCase.iosStatus = response.data.iosStatus;
                currentTestCase.iosFailReason = response.data.iosFailReason;
                currentTestCase.h5Status = response.data.h5Status;
                currentTestCase.h5FailReason = response.data.h5FailReason;

                // 刷新显示
                renderProjectList();
                updateStats();
                renderTestCaseDetail();

                // 显示提示
                const platformName = currentPlatform === 'android' ? 'Android' : (currentPlatform === 'ios' ? 'iOS' : 'H5');
                addLog('标记不通过', `用例: ${currentTestCase.id} - ${currentTestCase.name}, 平台: ${platformName}, 原因: ${reason}`);
                showToast(`${platformName} 已标记为：不通过`);
            } else {
                // API返回了，但success不是true
                console.error('API返回异常:', response);
                showToast('更新失败：服务器返回异常');
            }
        } catch (error) {
            console.error('更新失败原因失败:', error);
            showToast('更新失败：' + error.message);
        } finally {
            // 隐藏加载状态
            hideLoading();
        }
    }

    // 退出登录
    function handleLogout() {
        if (confirm('确定要退出登录吗？')) {
            apiService.logout();
        }
    }

    // ==================== 执行服务控制功能 ====================

    const CONTROL_API = 'http://localhost:8888';
    let executorStatusInterval = null;

    // 检查执行服务状态
    async function checkExecutorStatus() {
        try {
            const response = await fetch(`${CONTROL_API}/status`, {
                method: 'GET',
                timeout: 3000
            });

            if (!response.ok) {
                throw new Error('控制服务未响应');
            }

            const result = await response.json();
            updateExecutorButton(result.running);
            return result.running;

        } catch (error) {
            // 控制服务未运行，显示离线状态
            updateExecutorButton(false, true);
            return false;
        }
    }

    // 更新执行服务按钮状态
    function updateExecutorButton(isRunning, isOffline = false) {
        const btn = document.getElementById('executorControlBtn');
        const icon = document.getElementById('executorIcon');
        const text = document.getElementById('executorText');

        if (!btn || !icon || !text) return;

        if (isOffline) {
            // 控制服务未启动
            btn.className = 'executor-btn offline';
            icon.textContent = '⚠️';
            text.textContent = '控制服务离线';
            btn.disabled = true;
        } else if (isRunning) {
            // 执行服务运行中
            btn.className = 'executor-btn';
            icon.textContent = '🟢';
            text.textContent = '执行服务运行中';
            btn.disabled = false;
        } else {
            // 执行服务未运行
            btn.className = 'executor-btn offline';
            icon.textContent = '🔴';
            text.textContent = '启动执行服务';
            btn.disabled = false;
        }
    }

    // 切换执行服务状态
    async function toggleExecutor() {
        const btn = document.getElementById('executorControlBtn');
        const icon = document.getElementById('executorIcon');
        const text = document.getElementById('executorText');

        try {
            // 检查当前状态
            const isRunning = await checkExecutorStatus();

            if (isRunning) {
                // 停止执行服务
                if (!confirm('确定要停止执行服务吗？正在执行的任务会被中断。')) {
                    return;
                }

                showLoading('正在停止执行服务...');

                const response = await fetch(`${CONTROL_API}/stop`, {
                    method: 'POST'
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showToast('✅ 执行服务已停止');
                    updateExecutorButton(false);
                } else {
                    showToast('❌ 停止失败: ' + result.message);
                }
            } else {
                // 启动执行服务
                showLoading('正在启动执行服务...');

                const response = await fetch(`${CONTROL_API}/start`, {
                    method: 'POST'
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showToast('✅ 执行服务已启动');
                    updateExecutorButton(true);
                } else {
                    showToast('❌ 启动失败: ' + result.message);
                }
            }

        } catch (error) {
            hideLoading();
            console.error('控制执行服务失败:', error);
            showToast('❌ 控制服务未启动，请先运行: start-control-service.bat');
            updateExecutorButton(false, true);
        }
    }

    // 启动状态轮询
    function startExecutorStatusPolling() {
        // 立即检查一次
        checkExecutorStatus();

        // 每10秒检查一次状态
        executorStatusInterval = setInterval(() => {
            checkExecutorStatus();
        }, 10000);
    }

    // 停止状态轮询
    function stopExecutorStatusPolling() {
        if (executorStatusInterval) {
            clearInterval(executorStatusInterval);
            executorStatusInterval = null;
        }
    }

    // 加载用户信息
    function loadUserInfo() {
        try {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                const usernameElements = document.querySelectorAll('#username, #username2');
                usernameElements.forEach(el => {
                    if (el) el.textContent = user.username || 'Admin';
                });
            }
        } catch (e) {
            console.error('加载用户信息失败:', e);
        }
    }

    // ========== 进度统计功能 ==========

    let currentStatsMenuId = null; // 当前选中的统计菜单ID

    // 初始化统计模块
    async function initStatsModule() {
        try {
            // 加载一级菜单填充下拉框
            const result = await apiService.getMenusByLevel(1);
            if (result && result.success) {
                const select = document.getElementById('statsMenuSelect');
                select.innerHTML = '<option value="">请选择...</option>';

                result.data.forEach(menu => {
                    const option = document.createElement('option');
                    option.value = menu.id;
                    option.textContent = menu.name;
                    select.appendChild(option);
                });
            }
        } catch (e) {
            console.error('初始化统计模块失败:', e);
        }
    }

    // 加载统计数据
    async function loadStatsData() {
        const select = document.getElementById('statsMenuSelect');
        const menuId = select.value;

        if (!menuId) {
            // 未选择菜单，显示空状态
            document.getElementById('statsLoading').style.display = 'none';
            document.getElementById('statsContent').style.display = 'none';
            document.getElementById('statsEmpty').style.display = 'block';
            return;
        }

        currentStatsMenuId = menuId;

        // 显示加载状态
        document.getElementById('statsEmpty').style.display = 'none';
        document.getElementById('statsContent').style.display = 'none';
        document.getElementById('statsLoading').style.display = 'block';

        try {
            // 并行请求：当前菜单统计 + 子菜单列表
            const [statsResult, childrenResult] = await Promise.all([
                apiService.getStats(menuId),
                apiService.getMenuChildren(menuId)
            ]);

            if (!statsResult || !statsResult.success) {
                throw new Error('加载统计数据失败');
            }

            // 渲染整体统计
            renderOverallStats(select.options[select.selectedIndex].text, statsResult.data);

            // 加载子菜单统计
            if (childrenResult && childrenResult.success && childrenResult.data.length > 0) {
                await loadSubmenuStats(childrenResult.data);
                document.getElementById('submenuStatsEmpty').style.display = 'none';
                document.getElementById('submenuStatsTableContainer').style.display = 'block';
            } else {
                // 没有子菜单
                document.getElementById('submenuStatsTableContainer').style.display = 'none';
                document.getElementById('submenuStatsEmpty').style.display = 'block';
            }

            // 显示内容
            document.getElementById('statsLoading').style.display = 'none';
            document.getElementById('statsContent').style.display = 'block';

        } catch (e) {
            console.error('加载统计数据失败:', e);
            document.getElementById('statsLoading').style.display = 'none';
            alert('加载统计数据失败：' + e.message);
        }
    }

    // 渲染整体统计
    function renderOverallStats(menuName, stats) {
        // 设置菜单名称和总数
        document.getElementById('statsCurrentMenuName').textContent = menuName;
        document.getElementById('statsTotalCount').textContent = stats.total;

        // 渲染 Android 统计
        renderPlatformStats('Android', stats.android);

        // 渲染 iOS 统计
        renderPlatformStats('Ios', stats.ios);

        // 渲染 H5 统计
        renderPlatformStats('H5', stats.h5);
    }

    // 渲染单个平台统计
    function renderPlatformStats(platform, data) {
        const prefix = 'stats' + platform;

        // 更新数字
        document.getElementById(prefix + 'Pass').textContent = data.passed;
        document.getElementById(prefix + 'Fail').textContent = data.failed;
        document.getElementById(prefix + 'Skip').textContent = data.skipped;
        document.getElementById(prefix + 'Pending').textContent = data.pending;

        // 计算执行率（已执行 = 通过 + 失败 + 跳过）
        const total = data.actualTotal || data.passed + data.failed + data.skipped + data.pending;
        const executed = data.passed + data.failed + data.skipped;
        const executionRate = total > 0 ? Math.round((executed / total) * 100) : 0;

        // 更新执行率文本
        document.getElementById(prefix + 'Rate').textContent = `执行率: ${executionRate}%`;

        // 渲染进度条
        const progressBar = document.getElementById(prefix + 'ProgressBar');
        progressBar.innerHTML = '';

        if (total > 0) {
            const passPercent = (data.passed / total) * 100;
            const failPercent = (data.failed / total) * 100;
            const skipPercent = (data.skipped / total) * 100;

            if (data.passed > 0) {
                const passSegment = document.createElement('div');
                passSegment.className = 'progress-segment pass';
                passSegment.style.width = passPercent + '%';
                passSegment.textContent = data.passed;
                progressBar.appendChild(passSegment);
            }

            if (data.failed > 0) {
                const failSegment = document.createElement('div');
                failSegment.className = 'progress-segment fail';
                failSegment.style.width = failPercent + '%';
                failSegment.textContent = data.failed;
                progressBar.appendChild(failSegment);
            }

            if (data.skipped > 0) {
                const skipSegment = document.createElement('div');
                skipSegment.className = 'progress-segment skip';
                skipSegment.style.width = skipPercent + '%';
                skipSegment.textContent = data.skipped;
                progressBar.appendChild(skipSegment);
            }
        }
    }

    // 加载子菜单统计
    async function loadSubmenuStats(submenus) {
        const tbody = document.getElementById('submenuStatsTableBody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">加载中...</td></tr>';

        try {
            // 并行请求所有子菜单的统计数据
            const statsPromises = submenus.map(menu => apiService.getStats(menu.id));
            const statsResults = await Promise.all(statsPromises);

            // 清空表格
            tbody.innerHTML = '';

            // 渲染每个子菜单
            submenus.forEach((menu, index) => {
                const statsResult = statsResults[index];
                if (statsResult && statsResult.success) {
                    const row = createSubmenuRow(menu, statsResult.data);
                    tbody.appendChild(row);
                }
            });

        } catch (e) {
            console.error('加载子菜单统计失败:', e);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ef4444;">加载失败</td></tr>';
        }
    }

    // 创建子菜单表格行
    function createSubmenuRow(menu, stats) {
        const row = document.createElement('tr');

        // 计算各平台执行率（已执行 = 通过 + 失败 + 跳过）
        const androidTotal = stats.android.actualTotal || stats.android.passed + stats.android.failed + stats.android.skipped + stats.android.pending;
        const iosTotal = stats.ios.actualTotal || stats.ios.passed + stats.ios.failed + stats.ios.skipped + stats.ios.pending;
        const h5Total = stats.h5.actualTotal || stats.h5.passed + stats.h5.failed + stats.h5.skipped + stats.h5.pending;

        const androidExecuted = stats.android.passed + stats.android.failed + stats.android.skipped;
        const iosExecuted = stats.ios.passed + stats.ios.failed + stats.ios.skipped;
        const h5Executed = stats.h5.passed + stats.h5.failed + stats.h5.skipped;

        const androidExecRate = androidTotal > 0 ? (androidExecuted / androidTotal) * 100 : 0;
        const iosExecRate = iosTotal > 0 ? (iosExecuted / iosTotal) * 100 : 0;
        const h5ExecRate = h5Total > 0 ? (h5Executed / h5Total) * 100 : 0;

        // 整体执行率（三个平台的平均）
        const overallExecRate = Math.round((androidExecRate + iosExecRate + h5ExecRate) / 3);

        // 子菜单名称
        const nameCell = document.createElement('td');
        nameCell.innerHTML = `<span class="submenu-name">${menu.name}</span>`;
        row.appendChild(nameCell);

        // 总数
        const totalCell = document.createElement('td');
        totalCell.style.textAlign = 'center';
        totalCell.textContent = stats.total;
        row.appendChild(totalCell);

        // Android 进度
        row.appendChild(createPlatformProgressCell(androidExecuted, androidTotal, androidExecRate));

        // iOS 进度
        row.appendChild(createPlatformProgressCell(iosExecuted, iosTotal, iosExecRate));

        // H5 进度
        row.appendChild(createPlatformProgressCell(h5Executed, h5Total, h5ExecRate));

        // 执行率
        const rateCell = document.createElement('td');
        rateCell.style.textAlign = 'center';
        const rateClass = overallExecRate >= 70 ? 'high' : (overallExecRate >= 50 ? 'medium' : 'low');
        rateCell.innerHTML = `<span class="pass-rate ${rateClass}">${overallExecRate}%</span>`;
        row.appendChild(rateCell);

        return row;
    }

    // 创建平台进度单元格
    function createPlatformProgressCell(executed, total, execRate) {
        const cell = document.createElement('td');
        cell.style.textAlign = 'center';

        const progressClass = execRate >= 70 ? 'high' : (execRate >= 50 ? 'medium' : 'low');

        cell.innerHTML = `
            <div class="platform-progress">
                <span class="platform-progress-text">${executed}/${total}</span>
                <div class="mini-progress">
                    <div class="mini-progress-fill ${progressClass}" style="width: ${execRate}%;"></div>
                </div>
            </div>
        `;

        return cell;
    }

    // 刷新统计数据
    async function refreshStats() {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '🔄 刷新中...';

        try {
            // 如果选择了菜单，刷新菜单统计
            if (currentStatsMenuId) {
                await loadStatsData();
            }

            showToast('统计数据已刷新');
        } catch (e) {
            console.error('刷新统计失败:', e);
            alert('刷新失败：' + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = '🔄 刷新统计';
        }
    }

    // ========== 用例仓库相关代码 ==========
    let repositoryMenus = []; // 仓库菜单列表
    let selectedRepositoryMenus = new Set(); // 已选菜单
    let selectedRepositoryTestCases = new Set(); // 已选用例
    let currentRepositoryMenu = null; // 当前选中的菜单
    let currentRepositoryTestCase = null; // 当前选中的用例
    let repositoryInitialized = false; // 标记是否已初始化

    // 初始化用例仓库TAB
    async function initRepositoryTab() {
        if (repositoryInitialized) return;

        try {
            showLoading('正在加载仓库数据...');
            await loadRepositoryMenus();
            repositoryInitialized = true;
        } catch (error) {
            console.error('初始化仓库失败:', error);
            alert('加载仓库数据失败：' + error.message);
        } finally {
            hideLoading();
        }
    }

    // 加载仓库菜单
    async function loadRepositoryMenus() {
        try {
            const response = await apiService.getMenus({ is_repository: true });

            if (response.success) {
                repositoryMenus = response.data;
                renderRepositoryMenuTree();
                updateRepositoryStatistics();
            } else {
                throw new Error(response.error || '加载菜单失败');
            }
        } catch (error) {
            console.error('加载仓库菜单失败:', error);
            throw error;
        }
    }

    // 渲染仓库菜单树
    function renderRepositoryMenuTree() {
        const container = document.getElementById('repositoryMenuTree');
        if (!container) return;

        container.innerHTML = '';

        // 获取一级菜单
        const level1Menus = repositoryMenus.filter(m => m.level === 1);

        level1Menus.forEach(menu => {
            // 创建一级菜单
            const menuItem = createRepositoryMenuItem(menu);
            container.appendChild(menuItem);

            // 获取子菜单
            const childMenus = repositoryMenus.filter(m => m.parentId === menu.id);
            if (childMenus.length > 0) {
                const submenuList = document.createElement('div');
                submenuList.className = 'repository-submenu-list';

                childMenus.forEach(child => {
                    const childItem = createRepositoryMenuItem(child);
                    submenuList.appendChild(childItem);
                });

                container.appendChild(submenuList);
            }
        });
    }

    // 创建仓库菜单项
    function createRepositoryMenuItem(menu) {
        const div = document.createElement('div');
        div.className = 'repository-menu-item';
        div.id = `repo_menuitem_${menu.id}`;

        const icon = menu.level === 1 ? '📂' : '📄';
        const isChecked = menu.level === 1 || menu.level === 2; // 默认全选

        div.innerHTML = `
            <input type="checkbox" class="repository-menu-checkbox" id="repo_checkbox_${menu.id}" ${isChecked ? 'checked' : ''}>
            <span class="menu-icon">${icon}</span>
            <span class="menu-name">${menu.name}</span>
            <span class="menu-count">加载中...</span>
        `;

        // 复选框事件
        const checkbox = div.querySelector('.repository-menu-checkbox');
        checkbox.addEventListener('change', (e) => {
            e.stopPropagation();
            handleRepositoryMenuCheckboxChange(menu, checkbox.checked);
        });

        // 点击菜单项显示用例
        div.addEventListener('click', (e) => {
            if (e.target.type === 'checkbox') return;
            selectRepositoryMenu(menu);
        });

        // 默认勾选
        if (isChecked) {
            selectedRepositoryMenus.add(menu.id);
        }

        // 加载用例数量
        loadRepositoryTestCaseCount(menu.id);

        return div;
    }

    // 加载用例数量
    async function loadRepositoryTestCaseCount(menuId) {
        try {
            const response = await apiService.getTestCases(menuId);
            if (response.success) {
                const count = response.data.length;
                const countSpan = document.querySelector(`#repo_menuitem_${menuId} .menu-count`);
                if (countSpan) {
                    countSpan.textContent = `${count} 用例`;
                }
            }
        } catch (error) {
            console.error('加载用例数量失败:', error);
        }
    }

    // 处理菜单复选框变化
    function handleRepositoryMenuCheckboxChange(menu, checked) {
        if (checked) {
            selectedRepositoryMenus.add(menu.id);
        } else {
            selectedRepositoryMenus.delete(menu.id);
        }

        // 如果是一级菜单，联动子菜单
        if (menu.level === 1) {
            const childMenus = repositoryMenus.filter(m => m.parentId === menu.id);
            childMenus.forEach(child => {
                const childCheckbox = document.getElementById(`repo_checkbox_${child.id}`);
                if (childCheckbox) {
                    childCheckbox.checked = checked;
                    if (checked) {
                        selectedRepositoryMenus.add(child.id);
                    } else {
                        selectedRepositoryMenus.delete(child.id);
                    }
                }
                // 联动子菜单的用例
                updateRepositoryTestCasesSelection(child.id, checked);
            });

            // 联动用例
            updateRepositoryTestCasesSelection(menu.id, checked);
        }

        // 如果是二级菜单，更新父菜单状态
        if (menu.level === 2) {
            updateRepositoryParentCheckboxState(menu.parentId);
            updateRepositoryTestCasesSelection(menu.id, checked);
        }

        updateRepositoryStatistics();
    }

    // 更新父菜单复选框状态
    function updateRepositoryParentCheckboxState(parentId) {
        const childMenus = repositoryMenus.filter(m => m.parentId === parentId);
        if (childMenus.length === 0) return;

        const checkedCount = childMenus.filter(c => {
            const cb = document.getElementById(`repo_checkbox_${c.id}`);
            return cb && cb.checked;
        }).length;

        const parentCheckbox = document.getElementById(`repo_checkbox_${parentId}`);
        if (parentCheckbox) {
            if (checkedCount === 0) {
                parentCheckbox.checked = false;
                parentCheckbox.indeterminate = false;
            } else if (checkedCount === childMenus.length) {
                parentCheckbox.checked = true;
                parentCheckbox.indeterminate = false;
            } else {
                parentCheckbox.checked = false;
                parentCheckbox.indeterminate = true;
            }
        }
    }

    // 更新用例勾选状态
    async function updateRepositoryTestCasesSelection(menuId, checked) {
        try {
            const response = await apiService.getTestCases(menuId);
            if (response.success) {
                const testCases = response.data;
                testCases.forEach(tc => {
                    if (checked) {
                        selectedRepositoryTestCases.add(tc.id);
                    } else {
                        selectedRepositoryTestCases.delete(tc.id);
                    }

                    // 更新界面
                    const checkbox = document.getElementById(`repo_tc_checkbox_${tc.id}`);
                    if (checkbox) {
                        checkbox.checked = checked;
                    }
                });
            }
        } catch (error) {
            console.error('更新用例勾选状态失败:', error);
        }
    }

    // 选择菜单
    function selectRepositoryMenu(menu) {
        currentRepositoryMenu = menu;

        // 更新选中状态
        document.querySelectorAll('.repository-menu-item').forEach(item => {
            item.classList.remove('selected');
        });
        const menuItem = document.getElementById(`repo_menuitem_${menu.id}`);
        if (menuItem) {
            menuItem.classList.add('selected');
        }

        // 显示用例列表
        renderRepositoryTestCaseList(menu);

        // 更新当前菜单名
        const menuNameEl = document.getElementById('repositoryCurrentMenuName');
        if (menuNameEl) {
            menuNameEl.textContent = menu.name;
        }

        // 隐藏详情
        const detailEl = document.getElementById('repositoryTestcaseDetail');
        if (detailEl) {
            detailEl.style.display = 'none';
        }
    }

    // 渲染用例列表
    async function renderRepositoryTestCaseList(menu) {
        const container = document.getElementById('repositoryTestcaseList');
        if (!container) return;

        try {
            const response = await apiService.getTestCases(menu.id);

            if (!response.success || response.data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 64px; margin-bottom: 15px;">📋</div>
                        <p>该菜单下暂无用例</p>
                    </div>
                `;
                return;
            }

            const testCases = response.data;
            container.innerHTML = '';

            testCases.forEach(tc => {
                const div = document.createElement('div');
                div.className = 'repository-testcase-item';
                div.id = `repo_testcase_${tc.id}`;

                const isChecked = selectedRepositoryTestCases.has(tc.id);

                div.innerHTML = `
                    <input type="checkbox" class="repository-testcase-checkbox" id="repo_tc_checkbox_${tc.id}" ${isChecked ? 'checked' : ''}>
                    <div class="testcase-id">${tc.id}</div>
                    <div class="testcase-name">${tc.name}</div>
                    <div class="testcase-priority priority-${(tc.priority || 'P2').toLowerCase()}">${tc.priority || 'P2'}</div>
                `;

                // 复选框事件
                const checkbox = div.querySelector('.repository-testcase-checkbox');
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    if (checkbox.checked) {
                        selectedRepositoryTestCases.add(tc.id);
                    } else {
                        selectedRepositoryTestCases.delete(tc.id);
                    }
                    updateRepositoryStatistics();
                });

                // 点击显示详情
                div.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') return;
                    showRepositoryTestCaseDetail(tc);
                });

                container.appendChild(div);
            });
        } catch (error) {
            console.error('渲染用例列表失败:', error);
            container.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #ef4444;">
                    <div style="font-size: 64px; margin-bottom: 15px;">❌</div>
                    <p>加载用例失败：${error.message}</p>
                </div>
            `;
        }
    }

    // 显示用例详情
    function showRepositoryTestCaseDetail(testCase) {
        currentRepositoryTestCase = testCase;

        // 更新选中状态
        document.querySelectorAll('.repository-testcase-item').forEach(item => {
            item.classList.remove('selected');
        });
        const tcItem = document.getElementById(`repo_testcase_${testCase.id}`);
        if (tcItem) {
            tcItem.classList.add('selected');
        }

        const detailDiv = document.getElementById('repositoryTestcaseDetail');
        if (!detailDiv) return;

        detailDiv.style.display = 'block';

        const preconditions = testCase.preconditions || '无';
        const steps = testCase.steps || '无';
        const expectedResults = testCase.expectedResults || '无';

        detailDiv.innerHTML = `
            <div class="repository-detail-header">
                📄 ${testCase.id} - ${testCase.name}
                <span class="testcase-priority priority-${(testCase.priority || 'P2').toLowerCase()}">${testCase.priority || 'P2'}</span>
            </div>

            <div class="repository-detail-section">
                <div class="repository-detail-label">前置条件</div>
                <div class="repository-detail-content">${preconditions}</div>
            </div>

            <div class="repository-detail-section">
                <div class="repository-detail-label">操作步骤</div>
                <div class="repository-detail-content">${steps}</div>
            </div>

            <div class="repository-detail-section">
                <div class="repository-detail-label">预期结果</div>
                <div class="repository-detail-content">${expectedResults}</div>
            </div>
        `;
    }

    // 全选用例
    async function selectAllRepositoryTestCases() {
        if (!currentRepositoryMenu) return;

        try {
            const response = await apiService.getTestCases(currentRepositoryMenu.id);
            if (response.success) {
                response.data.forEach(tc => {
                    selectedRepositoryTestCases.add(tc.id);
                    const checkbox = document.getElementById(`repo_tc_checkbox_${tc.id}`);
                    if (checkbox) checkbox.checked = true;
                });
                updateRepositoryStatistics();
            }
        } catch (error) {
            console.error('全选用例失败:', error);
        }
    }

    // 全不选用例
    async function unselectAllRepositoryTestCases() {
        if (!currentRepositoryMenu) return;

        try {
            const response = await apiService.getTestCases(currentRepositoryMenu.id);
            if (response.success) {
                response.data.forEach(tc => {
                    selectedRepositoryTestCases.delete(tc.id);
                    const checkbox = document.getElementById(`repo_tc_checkbox_${tc.id}`);
                    if (checkbox) checkbox.checked = false;
                });
                updateRepositoryStatistics();
            }
        } catch (error) {
            console.error('取消选择用例失败:', error);
        }
    }

    // 更新统计
    function updateRepositoryStatistics() {
        const menuCountEl = document.getElementById('repositorySelectedMenuCount');
        if (menuCountEl) {
            menuCountEl.textContent = selectedRepositoryMenus.size;
        }

        const tcCountEl = document.getElementById('repositorySelectedTestCaseCount');
        if (tcCountEl) {
            tcCountEl.textContent = selectedRepositoryTestCases.size;
        }
    }

    // 打开创建版本弹窗
    function createVersionFromRepository() {
        const menuCount = selectedRepositoryMenus.size;
        const testCaseCount = selectedRepositoryTestCases.size;

        // 验证是否选择了模块
        if (menuCount === 0) {
            alert('请至少选择一个模块！');
            return;
        }

        if (testCaseCount === 0) {
            alert('选中的模块中没有用例！');
            return;
        }

        // 更新弹窗中的统计数据
        document.getElementById('modalSelectedMenuCount').textContent = menuCount + ' 个';
        document.getElementById('modalSelectedTestCaseCount').textContent = testCaseCount + ' 条';

        // 设置默认版本名称
        const versionInput = document.getElementById('versionNameInput');
        versionInput.value = '132回归用例';

        // 显示模态弹窗
        const modal = document.getElementById('createVersionModal');
        modal.classList.add('show');

        // 聚焦到输入框并选中文本
        setTimeout(() => {
            versionInput.focus();
            versionInput.select();
        }, 100);

        // 添加回车键快捷创建
        versionInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                confirmCreateVersion();
            }
        };
    }

    // 关闭创建版本弹窗
    function closeCreateVersionModal() {
        const modal = document.getElementById('createVersionModal');
        modal.classList.remove('show');

        // 清空输入框
        document.getElementById('versionNameInput').value = '';
    }

    // 点击背景关闭弹窗
    function closeCreateVersionModalOnBackdrop(event) {
        if (event.target.id === 'createVersionModal') {
            closeCreateVersionModal();
        }
    }

    // 确认创建版本
    async function confirmCreateVersion() {
        const versionInput = document.getElementById('versionNameInput');
        const versionName = versionInput.value.trim();

        if (!versionName) {
            alert('版本名称不能为空！');
            versionInput.focus();
            return;
        }

        const menuCount = selectedRepositoryMenus.size;
        const testCaseCount = selectedRepositoryTestCases.size;

        try {
            // 关闭弹窗
            closeCreateVersionModal();

            // 显示加载提示
            showLoading('正在创建版本...');

            // 调用API创建版本
            const response = await apiService.createVersion({
                versionName: versionName,
                selectedMenus: Array.from(selectedRepositoryMenus),
                selectedTestCases: Array.from(selectedRepositoryTestCases)
            });

            if (response.success) {
                hideLoading();
                showToast(`✅ 创建成功！版本"${versionName}"已添加到首页`);

                // 切换到首页并刷新
                switchTab('home');
                loadMenus();
            } else {
                throw new Error(response.error || '创建版本失败');
            }
        } catch (error) {
            console.error('创建版本失败:', error);
            hideLoading();
            alert('创建版本失败：' + error.message);
        }
    }

    // 页面加载时加载数据
    window.addEventListener('DOMContentLoaded', () => {
        loadUserInfo();
        loadFromLocalStorage();
        initStatsModule(); // 初始化统计模块
        startExecutorStatusPolling(); // 启动执行服务状态轮询

        // 添加ESC键关闭模态弹窗
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('createVersionModal');
                if (modal && modal.classList.contains('show')) {
                    closeCreateVersionModal();
                }
            }
        });
    });
</script>
</body>
</html>
