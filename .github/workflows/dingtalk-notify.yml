name: DingTalk Notification

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send DingTalk notification
        env:
          DINGTALK_WEBHOOK: 'https://oapi.dingtalk.com/robot/send?access_token=4a9730173b7e436c2449789d3fcad107925bd013454671bbcaca19e4d1fb6b09'
          DINGTALK_SECRET: 'SEC1c94eff36587ada3b8ebdbcea3e0e98138d505ad4b7303ef0383c0a78d1df1b5'
        run: |
          # è·å–æäº¤ä¿¡æ¯
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_SHA=$(git log -1 --pretty=%h)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          
          # ç”Ÿæˆæ—¶é—´æˆ³å’Œç­¾å
          TIMESTAMP=$(date +%s000)
          SECRET="${DINGTALK_SECRET}"
          SIGN_STRING="${TIMESTAMP}\n${SECRET}"
          SIGN=$(echo -ne "${SIGN_STRING}" | openssl dgst -sha256 -hmac "${SECRET}" -binary | base64 | python3 -c "import sys; from urllib.parse import quote_plus; print(quote_plus(sys.stdin.read().strip()))")
          
          # æ„å»ºæ¶ˆæ¯
          if [ "${{ github.event_name }}" == "push" ]; then
            ACTION="ğŸš€ ä»£ç æ¨é€"
          else
            ACTION="ğŸ”€ PR è¯·æ±‚"
          fi
          
          MESSAGE=$(cat <<-END
          {
            "msgtype": "markdown",
            "markdown": {
              "title": "Frontend æ„å»ºé€šçŸ¥",
              "text": "## ${ACTION}\n\n**ä»“åº“**: Frontend\n\n**æäº¤è€…**: ${COMMIT_AUTHOR}\n\n**æäº¤ä¿¡æ¯**: ${COMMIT_MESSAGE}\n\n**æäº¤SHA**: ${COMMIT_SHA}\n\n**åˆ†æ”¯**: ${{ github.ref_name }}\n\n**æŸ¥çœ‹è¯¦æƒ…**: [ç‚¹å‡»æŸ¥çœ‹](${COMMIT_URL})\n\n---\n\nâ° $(date +'%Y-%m-%d %H:%M:%S')"
            }
          }
          END
          )
          
          # å‘é€é€šçŸ¥
          curl -X POST "${DINGTALK_WEBHOOK}&timestamp=${TIMESTAMP}&sign=${SIGN}" \
            -H 'Content-Type: application/json' \
            -d "${MESSAGE}"
          
          echo "âœ… é’‰é’‰é€šçŸ¥å·²å‘é€"
